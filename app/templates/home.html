<!-- 
    Author: David Cruciani
-->

{% extends 'base.html' %}

{% block head %}
<script src="{{ url_for('static',filename='js/vendor/markdown-it.min.js') }}"></script>

{{ super() }}
{%endblock%}

{% block content %}
    <!-- Welcome Header Notification -->
    <div class="case-core-style mb-4" style="background: linear-gradient(135deg, #1f3763 0%, #456297 100%); border-radius: 8px; color: white;">
        <div class="p-3">
            <div class="d-flex align-items-center justify-content-between flex-wrap">
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-hand-wave fa-lg me-3"></i>
                    <h5 class="mb-0" v-if="home_stats">Welcome to Flowintel, <strong>[[home_stats.user.first_name]] [[home_stats.user.last_name]]</strong></h5>
                    <h5 class="mb-0" v-else>Welcome to Flowintel</h5>
                </div>
                <small style="opacity: 0.8;">
                    <i class="fa-solid fa-code-branch me-1"></i>Version: [[version]]
                </small>
            </div>
            <div class="d-flex flex-wrap gap-3 mt-3">
                <a v-if="home_stats" href="/case/" class="badge bg-light text-dark px-3 py-2 text-decoration-none">
                    <i class="fa-solid fa-folder-open me-1"></i>
                    <strong>[[home_stats.open_cases]]</strong> open [[ home_stats.open_cases === 1 ? 'case' : 'cases' ]]
                </a>
                <span class="badge bg-light text-dark px-3 py-2" v-else>
                    <i class="fa-solid fa-folder-open me-1"></i>
                    Loading...
                </span>
                <template v-if="home_stats">
                    <a v-if="home_stats.assigned_tasks > 0" href="/my_assignment/" class="badge bg-warning text-dark px-3 py-2 text-decoration-none">
                        <i class="fa-solid fa-list-check me-1"></i>
                        You have <strong>[[home_stats.assigned_tasks]]</strong> tasks assigned
                    </a>
                    <span v-else class="badge bg-success text-white px-3 py-2">
                        <i class="fa-solid fa-check me-1"></i>
                        No tasks assigned to you
                    </span>
                    <a v-if="home_stats.notifications > 0" href="/notification/" class="badge bg-danger text-white px-3 py-2 text-decoration-none">
                        <i class="fa-solid fa-bell me-1"></i>
                        You have <strong>[[home_stats.notifications]]</strong> notifications
                    </a>
                    <span v-else class="badge bg-light text-dark px-3 py-2">
                        <i class="fa-solid fa-bell-slash me-1"></i>
                        No waiting notifications
                    </span>
                </template>
            </div>
        </div>
    </div>

    <!-- Last Modifications Section -->
    <div class="case-core-style">
        <h5 class="mb-3"><i class="fa-solid fa-clock-rotate-left me-2"></i>Last modifications</h5>
        
        <div style="margin-left: 20px;">
            <template v-if="case_list">
                <template v-for="case_loc in case_list">
            <div class="list-group" style="margin-bottom: 15px;">
                <div style="display:flex; border-radius: 10px;">
                    <a :href="`/case/${case_loc.id}`" class="list-group-item list-group-item-action case-index-list">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1" style="font-weight: 600; color: #2c3e50;">
                                <i class="fa-solid fa-angle-right fa-sm me-2" style="color: #6c757d;"></i>[[ case_loc.id ]]-[[ case_loc.title ]]
                                <span style="font-size: 12px; vertical-align: middle;">
                                    <i v-if="case_loc.is_private" class="fa-solid fa-lock" 
                                    title="The case is private, only org present in can see this case"></i>
                                    <i v-else class="fa-solid fa-globe" 
                                    title="The case is public anyone can see this case but only org present in case can modify it"></i>
                                </span>
                                <button v-if="case_loc.link_to.length" disabled class="btn btn-outline-primary btn-sm" style="margin-left: 20px;">
                                    <i class="fa-solid fa-paperclip"></i> <span class="badge text-bg-secondary">[[case_loc.link_to.length]]</span>
                                </button>
                            </h5>                            
                            <small><i>Changed [[ (dayjs.utc(case_loc.last_modif).fromNow()) ]]</i></small>
                        </div>
                        <div class="d-flex w-100 justify-content-between">
                           <template v-if="case_loc.description">
                                <template v-if="case_loc.description.length > 300">
                                    <div class="position-relative">
                                        <button
                                            class="btn btn-outline-primary btn-sm float-end me-2"
                                            type="button"
                                            @click.stop.prevent="expandedCases[case_loc.id] = !expandedCases[case_loc.id]"
                                            title="See the full description"
                                        >
                                            <i :class="['fa-solid', expandedCases[case_loc.id] ? 'fa-chevron-up' : 'fa-chevron-down']"></i>
                                        </button>

                                        <!-- Show either truncated or full text -->
                                        <pre class="description" v-html="md.render(expandedCases[case_loc.id] ? case_loc.description : truncateText(case_loc.description))"></pre>
                                    </div>
                                </template>
                                <template v-else>
                                    <pre v-html="md.render(case_loc.description)" class="description"></pre>
                                </template>
                            </template>
                            <template v-else>
                                <p class="card-text"><i style="font-size: 12px;">No description</i></p>
                            </template>

                            <small v-if="status_info"><span :class="'badge rounded-pill text-bg-'+status_info.status[case_loc.status_id -1].bootstrap_style">[[ status_info.status[case_loc.status_id -1].name ]]</span></small>
                        </div>
                        <div class="d-flex w-100">
                            <small><i>[[case_loc.open_tasks]] open/ [[case_loc.closed_tasks]] closed</i></small>
                        </div>
                        <div class="d-flex w-100" v-if="case_loc.custom_tags" style="margin-top: 5px;">
                            <template v-for="custom_tag in case_loc.custom_tags">
                                <div class="tag" :style="{'background-color': custom_tag.color, 'color': getTextColor(custom_tag.color)}">
                                    <i v-if="custom_tag.icon" :class="custom_tag.icon"></i>
                                    [[custom_tag.name]]
                                </div>
                            </template>
                        </div>
                        <div class="d-flex w-100 justify-content-between">
                            <div v-if="case_loc.tags">
                                <template v-for="tag in case_loc.tags">
                                    <div class="tag" :title="tag.description" :style="{'background-color': tag.color, 'color': getTextColor(tag.color)}">
                                        <i class="fa-solid fa-tag" style="margin-right: 3px; margin-left: 3px;"></i>
                                        [[tag.name]]
                                    </div>
                                </template>
                            </div>
                            <div v-else></div>
                            <small v-if="case_loc.deadline" :title="case_loc.deadline"><i>Deadline [[dayjs.utc(case_loc.deadline).endOf().fromNow()]]</i></small>
                            <small v-else><i>No deadline</i></small>
                        </div>
                        <div class="d-flex w-100" v-if="case_loc.clusters">
                            <template v-for="cluster in case_loc.clusters">
                                <div :title="'Description:\n' + cluster.description + '\n\nMetadata:\n' + cluster.meta">
                                    <span class="cluster">
                                        <span v-html="mapIcon(cluster.icon)"></span>
                                    [[cluster.tag]]
                                    </span>
                                </div>
                            </template>
                        </div>
                    </a>
                </div>
            </div>
        </template>
            </template>
            <template v-else>
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </template>
        </div>
    </div>
{% endblock %}

{% block script %}
<script type="module">
    const { createApp, ref} = Vue
    import {message_list} from '/static/js/toaster.js'
    import {truncateText, getTextColor, mapIcon} from '/static/js/utils.js'
    createApp({
        delimiters: ['[[', ']]'],
        setup() {
            const case_list = ref(null)
            const status_info = ref(null)
            const version = ref(null)
            const home_stats = ref(null)
            const md = window.markdownit()
            const expandedCases = ref({})

            async function fetchCase() {
                case_list.value = null
                const res = await fetch("/last_case")
                let loc = await res.json()
                case_list.value = loc["cases"]
                
            }
            fetchCase()

            async function fetchVersion() {
                const res = await fetch("/version")
                let loc = await res.json()
                version.value = loc["version"]
                
            }
            fetchVersion()

            async function fetchHomeStats() {
                try {
                    const res = await fetch("/home_stats")
                    if (res.ok) {
                        let loc = await res.json()
                        home_stats.value = loc
                    } else {
                        console.error("Failed to fetch home stats:", res.status)
                    }
                } catch (e) {
                    console.error("Error fetching home stats:", e)
                }
            }
            fetchHomeStats()

            async function fetchStatus() {
                status_info.value = null
                const res = await fetch(
                    '/case/get_status'
                )
                status_info.value = await res.json()
            }
            fetchStatus()

            return {
                message_list,
                dayjs,
                getTextColor,
                mapIcon,
                truncateText,
                md,

                case_list,
                status_info,
                version,
                home_stats,
                expandedCases
            }
        }
    }).mount('#main-container')

</script>
{% endblock %}