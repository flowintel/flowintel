<!-- 
    Author: David Cruciani
-->

{% extends 'base.html' %}

{% block head %}
<title>Notifications - {{ config.APP_NAME }}</title>
{{ super() }}
{%endblock%}


{% block content %}

<div class="case-core-style" style="border-radius: 0;">
    <div class="row align-items-center">
        <div class="col-auto d-flex align-items-center">
            <h5 class="mb-0"><i class="fa-solid fa-bell me-2"></i>Notifications</h5>
            <button v-if="!flag_is_read" class="btn btn-primary btn-sm ms-3" @click="mark_all_read()" title="Mark all messages as read">
                <i class="fa-solid fa-check fa-sm"></i>
            </button>
        </div>

        <div class="col-auto">
            <div class="btn-group btn-group-sm" role="group" aria-label="Filter options">
                <button type="button" class="btn btn-sm" :class="!flag_is_read ? 'btn-primary' : 'btn-outline-secondary'" @click="select_unread_read(true)">
                    <i class="fa-solid fa-envelope fa-sm me-1"></i>Unread
                </button>
                <button type="button" class="btn btn-sm" :class="flag_is_read ? 'btn-primary' : 'btn-outline-secondary'" @click="select_unread_read(false)">
                    <i class="fa-solid fa-envelope-open fa-sm me-1"></i>Read
                </button>
            </div>
        </div>
    </div>
</div>

<div v-if="show_password_reset_prompt" class="alert alert-success alert-dismissible fade show mt-3" role="alert">
    <i class="fa-solid fa-check-circle me-2"></i>
    <strong>Password reset completed.</strong> Would you like to mark all password reset notifications for this user for all admins as read?
    <div class="mt-2">
        <button class="btn btn-sm btn-success me-2" @click="mark_password_reset_notifs_as_read()">
            <i class="fa-solid fa-check me-1"></i>Yes, mark all as read
        </button>
        <button class="btn btn-sm btn-secondary" @click="dismiss_password_reset_prompt()">
            No, keep them
        </button>
    </div>
</div>

<hr class="fading-line-2 mt-4 mb-4">

<div class="case-core-style">
    <template v-if="notif_list">
        <template v-if="notif_list.length === 0">
            <div class="text-center text-muted py-4">
                <i class="fa-solid fa-inbox fa-2x mb-2"></i>
                <p class="mb-0">No notifications</p>
            </div>
        </template>
        <template v-else>
            <template v-for="notif in notif_list">
                <a :href="getNotificationUrl(notif)" class="list-group-item list-group-item-action case-index-list d-flex align-items-center" :style="flag_is_read ? 'background-color: #f8f9fa;' : ''">
                    <input class="form-check-input me-3" type="checkbox" @click.prevent="read_notification(notif)" title="Mark as read/unread">
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-1" style="font-size: 0.95rem;">
                                <i class="fa-solid fa-angle-right me-2"></i>
                                <i v-if="notif.html_icon" :class="notif.html_icon" class="me-1"></i>
                                [[notif.message]]
                            </h5>
                            <span v-if="flag_is_read" class="badge bg-secondary">Read</span>
                        </div>
                        <small class="text-muted">
                            <i class="fa-solid fa-clock me-1"></i>
                            <span v-if="flag_is_read">
                                Read [[dayjs.utc(notif.read_date).fromNow()]]
                            </span>
                            <span v-else>
                                Received [[dayjs.utc(notif.creation_date).fromNow()]]
                            </span>
                        </small>
                    </div>
                    <button class="btn btn-outline-danger btn-sm ms-3" @click.prevent="delete_notif(notif)" type="button" title="Delete notification">
                        <i class="fa-solid fa-trash fa-sm"></i>
                    </button>
                </a>
            </template>
        </template>
    </template>
    <template v-else>
        <div class="text-center py-4">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </template>
</div>

{% endblock %}


{% block script %}
<script type="module">
    const { createApp, ref, onMounted } = Vue
    import {display_toast, message_list} from '/static/js/toaster.js'

    createApp({
        delimiters: ['[[', ']]'],
        setup() {
            let flag_is_read = ref(false)
            const notif_list = ref(null)
            const show_password_reset_prompt = ref(false)
            const password_reset_user_id = ref(null)

            // Check URL parameters for password reset completion
            const urlParams = new URLSearchParams(window.location.search)
            if (urlParams.get('password_reset_completed') === 'true') {
                show_password_reset_prompt.value = true
                password_reset_user_id.value = urlParams.get('user_id')
                window.history.replaceState({}, document.title, window.location.pathname)
            }

            async function fetchNotif(unread_read) {
                notif_list.value = null
                const res = await fetch('/notification/get_user_notifications?unread_read=' + unread_read)
                let loc = await res.json()
                notif_list.value = loc["notif"]
                if(!unread_read){
                    flag_is_read.value = true
                }
                else{
                    flag_is_read.value = false
                }
            }

            async function read_notification(notif){
                const res = await fetch("/notification/read_notification/" + notif.id)

                if(await res.status == 200){
                    notif.is_read = !notif.is_read
                    notif.read_date = Date.now()

                    let index = notif_list.value.indexOf(notif)
                    if(index > -1)
                        notif_list.value.splice(index, 1)
                }
                display_toast(res)
            }

            async function select_unread_read(unread_read){
                if(unread_read){
                    fetchNotif(true)
                }else{
                    fetchNotif(false)
                }
            }

            async function delete_notif(notif){
                const res = await fetch("/notification/delete/" + notif.id)

                if(await res.status == 200){
                    let index = notif_list.value.indexOf(notif)
                    if(index > -1)
                        notif_list.value.splice(index, 1)
                }
                display_toast(res)
            }

            async function mark_all_read(){
                const res = await fetch("/notification/mark_all_read")

                if(await res.status == 200){
                    notif_list.value = []
                }
                display_toast(res)
            }

            async function mark_password_reset_notifs_as_read() {
                if (!password_reset_user_id.value) return

                const res = await fetch(`/notification/mark_password_reset_notifs_as_read/${password_reset_user_id.value}`)
                
                if (await res.status == 200) {
                    show_password_reset_prompt.value = false
                    fetchNotif(true)
                }
                display_toast(res)
            }

            function dismiss_password_reset_prompt() {
                show_password_reset_prompt.value = false
            }

            function getNotificationUrl(notif) {
                // If case_id is null or undefined, redirect to homepage
                if (!notif.case_id) {
                    return '/';
                }
                // If case_id is negative, it's a user ID for admin edit page.
                // NOTE: This convention (negative case_id means user ID) may be confusing for future maintainers.
                // Consider using a more explicit property (e.g., notif.user_id or notif.type) to distinguish notification types.
                if (notif.case_id < 0) {
                    return `/admin/edit_user/${Math.abs(notif.case_id)}?from_notif=true`;
                }
                // Otherwise, it's a regular case ID
                return `/case/${notif.case_id}`;
            }

            fetchNotif(true)

            return {
                message_list,
                notif_list,
                flag_is_read,
                read_notification,
                select_unread_read,
                delete_notif,
                dayjs,
                mark_all_read,
                getNotificationUrl,
                show_password_reset_prompt,
                mark_password_reset_notifs_as_read,
                dismiss_password_reset_prompt
            }
        }
    }).mount('#main-container')

</script>
{% endblock %}