<!-- 
    Author: David Cruciani
-->
{% extends 'base.html' %}
{% import 'macros/form_macros.html' as f %}

{% block content %}
    {% if not edit_mode %}
        <div class="case-core-style" style="border-radius: 0;">
            <h5 class="mb-0"><i class="fa-solid fa-user-plus me-2"></i>Create an account</h5>
        </div>
    {% else %}
        <div class="case-core-style" style="border-radius: 0;">
            <h5 class="mb-0"><i class="fa-solid fa-user-pen me-2"></i>Edit an account</h5>
        </div>
    {% endif %}

    {% if edit_mode and from_notification %}
        <div class="alert alert-info mt-3 mb-0" role="alert">
            <i class="fa-solid fa-info-circle me-2"></i>
            <strong>Password reset request:</strong> Editing a user profile on request of the user
        </div>
    {% endif %}

    <hr class="fading-line-2 mb-4 mt-4">

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form action="" method="post" class="case-core-style">
        {{ form.hidden_tag() }}
        {% if not edit_mode %}
            {{form.user_id}}
        {%endif%}
        <div class="row">
            <div class="col">
                {{form.first_name.label(class_="col-form-label")}}
                <span style="color:red">*</span>
                {{form.first_name(class_="form-control")}}
                {% if form.first_name.errors %}
                    <div style="color: red;">{{form.first_name.errors[0] | safe}}</div>
                {%endif%}
            </div>
            <div class="col">
                {{form.last_name.label(class_="col-form-label")}}
                <span style="color:red">*</span>
                {{form.last_name(class_="form-control")}}
                {% if form.last_name.errors %}
                    <div style="color: red;">{{form.last_name.errors[0] | safe}}</div>
                {%endif%}
            </div>
        </div>
        <div class="row">
            <div class="col">
                {{form.nickname.label(class_="col-form-label")}}
                {{form.nickname(class_="form-control")}}
                {% if form.nickname.errors %}
                    <div style="color: red;">{{form.nickname.errors[0] | safe}}</div>
                {%endif%}
            </div>
        </div>
        <div class="row">
            <div class="col">
                {{form.email.label(class_="col-form-label")}}
                <span style="color:red">*</span>
                {{form.email(class_="form-control")}}
                {% if form.email.errors %}
                    <div style="color: red;">{{form.email.errors[0] | safe}}</div>
                {%endif%}
            </div>
            <div class="col">
                {{form.matrix_id.label(class_="col-form-label")}}
                {{form.matrix_id(class_="form-control")}}
                {% if form.matrix_id.errors %}
                    <div style="color: red;">{{form.matrix_id.errors[0] | safe}}</div>
                {%endif%}
            </div>
        </div>        
        {% if edit_mode %}
        <div class="row mt-3">
            <div class="col">
                <div class="form-check">
                    {{form.change_password(class_="form-check-input", id="changePasswordCheckbox")}}
                    {{form.change_password.label(class_="form-check-label", for="changePasswordCheckbox")}}
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="row" id="password-fields" {% if edit_mode %}style="display: none;" data-edit-mode="true"{% else %}data-edit-mode="false"{% endif %}>
            <div class="col">
                <label for="password" class="col-form-label">{{ form.password.label }}</label>  
                {% if not edit_mode %}
                    <span style="color:red">*</span>
                {%endif%}
                <div class="position-relative">
                    <div class="position-relative">
                        <input class="form-control pe-5" id="password" name="password" type="password" v-model="password">
                        <i class="fa fa-eye position-absolute top-50 end-0 translate-middle-y me-3"
                        style="cursor: pointer"
                        id="togglePasswordIcon"
                        @click="togglePassword"></i>
                    </div>

                </div>
                {% if form.password.errors %}
                    <div style="color: red;">{{ form.password.errors[0] | safe }}</div>
                {% endif %}

                <!-- Password rules -->
                <ul style="margin-top: 10px; padding-left: 20px; list-style: none;" v-if="password">
                    <li :class="password.length >= 8 ? 'text-success' : 'text-danger'">
                        <span v-if="password.length >= 8">
                            <i class="fa-solid fa-check"></i>
                        </span>
                        <span v-else>
                            <i class="fa-solid fa-xmark"></i>
                        </span> At least 8 characters
                    </li>
                    <li :class="/[A-Z]/.test(password) ? 'text-success' : 'text-danger'">
                        <span v-if="/[A-Z]/.test(password)">
                            <i class="fa-solid fa-check"></i>
                        </span>
                        <span v-else>
                            <i class="fa-solid fa-xmark"></i>
                        </span> At least one uppercase letter
                    </li>
                    <li :class="/[a-z]/.test(password) ? 'text-success' : 'text-danger'">
                        <span v-if="/[a-z]/.test(password)">
                            <i class="fa-solid fa-check"></i>
                        </span>
                        <span v-else>
                            <i class="fa-solid fa-xmark"></i>
                        </span> At least one lowercase letter
                    </li>
                    <li :class="/[0-9]/.test(password) ? 'text-success' : 'text-danger'">
                        <span v-if="/[0-9]/.test(password)">
                            <i class="fa-solid fa-check"></i>
                        </span>
                        <span v-else>
                            <i class="fa-solid fa-xmark"></i>
                        </span> At least one digit
                    </li>
                </ul>
            </div>
            <div class="col">
                {{form.password2.label(class_="col-form-label")}}
                <input class="form-control" id="password2" name="password2" type="password" v-model="password2">
                {% if form.password2.errors %}
                    <div style="color: red;">{{form.password2.errors[0] | safe}}</div>
                {%endif%}
                <div v-if="password && password2 && password !== password2" style="color: red; margin-top: 5px;">
                    <i class="fa-solid fa-xmark"></i> Passwords do not match
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                {{form.role.label(class_="col-form-label")}}
                <span style="color:red">*</span>
                {{form.role(class_="form-control")}}
                {% if form.role.errors %}
                    <div style="color: red;">{{form.role.errors[0] | safe}}</div>
                {%endif%}
            </div>
            <div class="col">
                {{form.org.label(class_="col-form-label")}}
                <span style="color:red">*</span>
                {{form.org(class_="form-control")}}
                {% if form.org.errors %}
                    <div style="color: red;">{{form.org.errors[0] | safe}}</div>
                {%endif%}
            </div>
        </div>
        <div class="modal-footer" style="margin-top: 10px;">
            {{form.submit(class='btn btn-primary', id='submitBtn')}}
        </div>
    </form>
{% endblock %}

{% block script %}
<script type="module">
    document.getElementById("password").setAttribute("v-model", "password");
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            const password = ref('')
            const password2 = ref('')
            const change_pwd = ref(false)

            const is_valid = computed(() => {
                return password.value.length >= 8 &&
                    /[A-Z]/.test(password.value) &&
                    /[a-z]/.test(password.value) &&
                    /[0-9]/.test(password.value)
            })

            const passwords_match = computed(() => password.value === password2.value)

            const can_submit = computed(() => {
                const edit_mode = document.getElementById('password-fields').dataset.editMode === 'true'
                if (!edit_mode) {
                    return is_valid.value && passwords_match.value
                } else {
                    if (change_pwd.value) {
                        return is_valid.value && passwords_match.value
                    }
                    return true
                }
            })

            const togglePassword = () => {
                const input = document.getElementById("password")
                const icon = document.getElementById("togglePasswordIcon")
                input.type = input.type === "password" ? "text" : "password"
                icon.classList.toggle("fa-eye")
                icon.classList.toggle("fa-eye-slash")
            }

            onMounted(() => {
                const submit_btn = document.getElementById('submitBtn')
                const checkbox = document.getElementById('changePasswordCheckbox')
                
                if (checkbox) {
                    change_pwd.value = checkbox.checked
                    checkbox.addEventListener('change', (e) => {
                        change_pwd.value = e.target.checked
                    })
                }
                
                watch(can_submit, (val) => {
                    submit_btn.disabled = !val
                }, { immediate: true })
            })

            return { password, password2, togglePassword }
        }
    }).mount('#password-fields');

    document.addEventListener('DOMContentLoaded', function() {
        const checkbox = document.getElementById('changePasswordCheckbox');
        if (checkbox) {
            const passwordFields = document.getElementById('password-fields');
            
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    passwordFields.style.display = ''
                } else {
                    passwordFields.style.display = 'none'
                    const pwd = document.getElementById('password')
                    const pwd2 = document.getElementById('password2')
                    if (pwd) {
                        pwd.value = ''
                        pwd.dispatchEvent(new Event('input'))
                    }
                    if (pwd2) {
                        pwd2.value = ''
                        pwd2.dispatchEvent(new Event('input'))
                    }
                }
            });
        }
    });
</script>
{% endblock %}