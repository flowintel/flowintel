{% extends 'base.html' %}
{% import 'macros/form_macros.html' as f %}

{% block content %}
    {% if not edit_mode %}
        <div class="case-core-style" style="border-radius: 0;">
            <h5 class="mb-0"><i class="fa-solid fa-user-shield me-2"></i>Create a role</h5>
        </div>
    {% else %}
        <div class="case-core-style" style="border-radius: 0;">
            <h5 class="mb-0"><i class="fa-solid fa-user-shield me-2"></i>{% if is_system_role %}View{% else %}Edit{% endif %} a role</h5>
        </div>
    {% endif %}

    <hr class="fading-line-2 mb-4 mt-4">

    <form action="" method="post" class="case-core-style">
        {{ form.hidden_tag() }}
        {% if edit_mode and role %}
            {{form.role_id(value=role.id)}}
        {% endif %}
        <div class="modal-body">
            <div class="row">
                <div class="mb-3 w-100">
                    {{form.name.label(class_="col-form-label")}}<span class="text-danger">*</span>:
                    {% if is_system_role %}
                        {{form.name(class_="form-control", readonly=true)}}
                    {% else %}
                        {{form.name(class_="form-control")}}
                    {% endif %}
                    {% if form.name.errors %}
                        <div style="color: red;">{{form.name.errors[0] | safe}}</div>
                    {%endif%}
                </div>
            </div>
            <div class="mb-3">
                <label for="description" class="col-form-label">Description:</label>
                {% if is_system_role %}
                    {{form.description(class_="form-control", rows=4, readonly=true)}}
                {% else %}
                    {{form.description(class_="form-control", rows=4)}}
                {% endif %}
                {% if form.description.errors %}
                    <div style="color: red;">{{form.description.errors[0] | safe}}</div>
                {%endif%}
            </div>

            <div class="mb-3">
                <label class="col-form-label fw-bold">Permissions:</label>
                <div class="alert alert-info py-2 px-3 mb-3" style="font-size: 0.875rem;">
                    <i class="fa-solid fa-info-circle me-1"></i>
                    <strong>Note:</strong> Select one of the three role types below. Additional permissions apply to the Editor role only. An Admin already possesses all additional permissions, and a Read Only cannot have any additional permissions.
                </div>
                
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <h6 class="mb-0 fw-bold">System role</h6>
                    </div>
                    <table class="table table-sm table-bordered mb-0">
                        <tbody>
                            <tr>
                                <td title="Full administrative access to all features"><i class="fa-solid fa-shield-halved me-2" style="color: #dc3545;"></i>Admin</td>
                                <td style="width: 100px; text-align: center;">
                                    {% if is_system_role %}
                                        {{form.admin(id="admin_checkbox", class_="form-check-input", disabled=true)}}
                                    {% else %}
                                        {{form.admin(id="admin_checkbox", class_="form-check-input")}}
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td title="User can only view data, cannot make changes"><i class="fa-solid fa-eye me-2" style="color: #0dcaf0;"></i>Read Only</td>
                                <td style="text-align: center;">
                                    {% if is_system_role %}
                                        {{form.read_only(id="read_only_checkbox", class_="form-check-input", disabled=true)}}
                                    {% else %}
                                        {{form.read_only(id="read_only_checkbox", class_="form-check-input")}}
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td title="Can create and edit content, but not perform admin functions"><i class="fa-solid fa-pen me-2" style="color: #198754;"></i>Editor</td>
                                <td style="text-align: center;">
                                    {% if is_system_role %}
                                        <input type="checkbox" id="editor_checkbox" class="form-check-input" disabled>
                                    {% else %}
                                        <input type="checkbox" id="editor_checkbox" class="form-check-input">
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <h6 class="mb-0 fw-bold text-muted">Additional permissions <small>(Editor only)</small></h6>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted fw-semibold ps-2"><i class="fa-solid fa-building me-1"></i>Organisation Management</small>
                        <table class="table table-sm table-bordered mb-0 mt-1">
                            <tbody>
                                <tr>
                                    <td title="Allows a user to add, create or edit users within an organisation">Org Admin</td>
                                    <td style="width: 100px; text-align: center;">
                                        {% if is_system_role %}
                                            {{form.org_admin(id="org_admin_checkbox", class_="form-check-input", disabled=true)}}
                                        {% else %}
                                            {{form.org_admin(id="org_admin_checkbox", class_="form-check-input")}}
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mb-2">
                        <small class="text-muted fw-semibold ps-2"><i class="fa-solid fa-lock me-1"></i>Privileged Cases</small>
                        <table class="table table-sm table-bordered mb-0 mt-1">
                            <tbody>
                                <tr>
                                    <td title="Can create and complete cases, and can edit a case to a privileged case">Case Admin</td>
                                    <td style="width: 100px; text-align: center;">
                                        {% if is_system_role %}
                                            {{form.case_admin(id="case_admin_checkbox", class_="form-check-input", disabled=true)}}
                                        {% else %}
                                            {{form.case_admin(id="case_admin_checkbox", class_="form-check-input")}}
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td title="Can approve a task for privileged cases">Queue Admin</td>
                                    <td style="text-align: center;">
                                        {% if is_system_role %}
                                            {{form.queue_admin(id="queue_admin_checkbox", class_="form-check-input", disabled=true)}}
                                        {% else %}
                                            {{form.queue_admin(id="queue_admin_checkbox", class_="form-check-input")}}
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td title="Can request a task for privileged cases">Queuer</td>
                                    <td style="text-align: center;">
                                        {% if is_system_role %}
                                            {{form.queuer(id="queuer_checkbox", class_="form-check-input", disabled=true)}}
                                        {% else %}
                                            {{form.queuer(id="queuer_checkbox", class_="form-check-input")}}
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mb-2">
                        <small class="text-muted fw-semibold ps-2"><i class="fa-solid fa-file-lines me-1"></i>Audit & Logging</small>
                        <table class="table table-sm table-bordered mb-0 mt-1">
                            <tbody>
                                <tr>
                                    <td title="Allows users to view audit logs">Audit Viewer</td>
                                    <td style="width: 100px; text-align: center;">
                                        {% if is_system_role %}
                                            {{form.audit_viewer(id="audit_viewer_checkbox", class_="form-check-input", disabled=true)}}
                                        {% else %}
                                            {{form.audit_viewer(id="audit_viewer_checkbox", class_="form-check-input")}}
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div>
                        <small class="text-muted fw-semibold ps-2"><i class="fa-solid fa-clock me-1"></i>Coming soon</small>
                        <table class="table table-sm table-bordered mb-0 mt-1">
                            <tbody>
                                <tr class="text-muted">
                                    <td title="Allows users to edit case or task templates">Template Editor <small class="fst-italic">(planned)</small></td>
                                    <td style="text-align: center;">
                                        <input type="checkbox" class="form-check-input" disabled>
                                    </td>
                                </tr>
                                <tr class="text-muted">
                                    <td title="Allows users to sync data with MISP">MISP Editor <small class="fst-italic">(planned)</small></td>
                                    <td style="text-align: center;">
                                        <input type="checkbox" class="form-check-input" disabled>
                                    </td>
                                </tr>
                                <tr class="text-muted">
                                    <td title="Allows users to import data">Importer <small class="fst-italic">(planned)</small></td>
                                    <td style="text-align: center;">
                                        <input type="checkbox" class="form-check-input" disabled>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a class="btn btn-secondary" href="{{ url_for('admin.roles') }}">{% if is_system_role %}Close{% else %}Cancel{% endif %}</a>
            {% if not is_system_role %}
                {{form.submit(class_="btn btn-primary", value="Save" if edit_mode else "Create")}}
            {% endif %}
        </div>
    </form>
{% endblock %}

{% block script %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const adminCheckbox = document.getElementById('admin_checkbox');
            const readOnlyCheckbox = document.getElementById('read_only_checkbox');
            const editorCheckbox = document.getElementById('editor_checkbox');
            const orgAdminCheckbox = document.getElementById('org_admin_checkbox');
            const caseAdminCheckbox = document.getElementById('case_admin_checkbox');
            const queueAdminCheckbox = document.getElementById('queue_admin_checkbox');
            const queuerCheckbox = document.getElementById('queuer_checkbox');
            const auditViewerCheckbox = document.getElementById('audit_viewer_checkbox');
            
            if (adminCheckbox && readOnlyCheckbox && editorCheckbox && orgAdminCheckbox && caseAdminCheckbox && queueAdminCheckbox && queuerCheckbox && auditViewerCheckbox) {
                function updateEditorState() {
                    editorCheckbox.checked = !adminCheckbox.checked && !readOnlyCheckbox.checked;
                }
                
                updateEditorState();
                
                adminCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        readOnlyCheckbox.checked = false;
                    }
                    updateEditorState();
                });
                
                readOnlyCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        adminCheckbox.checked = false;
                        orgAdminCheckbox.checked = false;
                        caseAdminCheckbox.checked = false;
                        queueAdminCheckbox.checked = false;
                        queuerCheckbox.checked = false;
                        auditViewerCheckbox.checked = false;
                    }
                    updateEditorState();
                });
                
                // When editor is checked, uncheck admin and read_only
                editorCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        adminCheckbox.checked = false;
                        readOnlyCheckbox.checked = false;
                    }
                });
                
                // Additional permissions force Editor role
                [orgAdminCheckbox, caseAdminCheckbox, queueAdminCheckbox, queuerCheckbox, auditViewerCheckbox].forEach(function(checkbox) {
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            readOnlyCheckbox.checked = false;
                        }
                        updateEditorState();
                    });
                });
            }
        });
    </script>
{% endblock %}
