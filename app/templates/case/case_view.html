<!-- 
    Author: David Cruciani
-->

{% extends 'base.html' %}

{% block head %}
<script src="{{ url_for('static',filename='js/vendor/markdown-it.min.js') }}"></script>
<script src="{{ url_for('static',filename='js/vendor/codemirror.js') }}"></script>
<script src="{{ url_for('static',filename='js/mermaid-markdown.js') }}"></script>
<script src="{{ url_for('static',filename='js/vendor/handlebars.min.js') }}"></script>
<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='css/timeline.css') }}">

<script src="{{ url_for('static',filename='js/vendor/timelinejs.js') }}"></script>
<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='css/vendor/timelinejs.css') }}">

<script src="{{ url_for('static',filename='js/vendor/Sortable.min.js') }}"></script>

<title>View case #{{ case.id }} - {{ config.APP_NAME }}</title>
{{ super() }}
{%endblock%}

{% block content %}
<!-- Case Header Card -->
<div class="case-header-card">
    <div class="case-header-top">
        <div class="case-title-row">
            <h1 class="case-title">
                <span class="case-id">{{case.id}}</span>
                {{case.title}}
            </h1>
            <div class="case-badges">
                <span v-if="cases_info" class="case-visibility-badge" :title="cases_info.case.is_private ? 'Private case - only org members can see' : 'Public case - anyone can view'">
                    <i v-if="cases_info.case.is_private" class="fa-solid fa-lock"></i>
                    <i v-else class="fa-solid fa-globe"></i>
                </span>
                <span v-if="cases_info && cases_info.case.privileged_case" class="case-visibility-badge" title="Privileged case - four-eye-review workflow">
                    <i class="fa-solid fa-user-shield" style="color: #dc3545;"></i>
                </span>
                <span v-if="status_info" :class="'badge rounded-pill text-bg-' + status_info.status[{{case.status_id}} -1].bootstrap_style" id="id-case-status">
                    [[ status_info.status[{{case.status_id}} -1].name ]]
                </span>
                <span v-if="cases_info && cases_info.case.is_updated_from_misp" title="Created from MISP event">
                    <img :src="'/static/icons/' + cases_info.case.misp_icon" style="max-width: 24px; vertical-align: middle;">
                </span>
            </div>
        </div>
        <div class="case-header-actions" v-if="cases_info">
            <action_buttons 
                :cases_info="cases_info"
                :status_info="status_info">
            </action_buttons>
        </div>
    </div>
    
    <div class="case-header-main">
        {% if case.ticket_id %}
        <div class="case-ticket-row">
            <span class="ticket-badge" title="Ticket ID">
                <i class="fa-solid fa-ticket"></i> {{case.ticket_id}}
            </span>
        </div>
        {% endif %}
    </div>

    <!-- Case Meta Information -->
    <div class="case-meta-grid" v-if="cases_info">
        <div class="case-meta-item" :title="'Created: ' + cases_info.case.creation_date">
            <i class="fa-solid fa-calendar-plus fa-fw"></i>
            <span class="meta-label">Created</span>
            <span class="meta-value">[[ dayjs.utc(cases_info.case.creation_date).fromNow() ]]</span>
        </div>
        <div class="case-meta-item" :title="'Modified: ' + cases_info.case.last_modif">
            <i class="fa-solid fa-clock-rotate-left fa-fw"></i>
            <span class="meta-label">Modified</span>
            <span class="meta-value">[[ dayjs.utc(cases_info.case.last_modif).fromNow() ]]</span>
        </div>
        <div class="case-meta-item">
            <i class="fa-solid fa-list-check fa-fw"></i>
            <span class="meta-label">Tasks</span>
            <span class="meta-value">[[open_closed.open]] open / [[open_closed.closed]] closed</span>
        </div>
        {% if case.deadline %}
        <div class="case-meta-item case-meta-deadline" :title="'Deadline: ' + cases_info.case.deadline">
            <i class="fa-solid fa-hourglass-half fa-fw"></i>
            <span class="meta-label">Deadline</span>
            <span class="meta-value">[[ dayjs.utc(cases_info.case.deadline).endOf().fromNow() ]]</span>
        </div>
        {% endif %}
        {% if case.recurring_type %}
        <div class="case-meta-item" title="Recurring schedule">
            <i class="fa-solid fa-repeat fa-fw"></i>
            <span class="meta-label">Recurring</span>
            <span class="meta-value">{{case.recurring_type}}{% if case.recurring_date %} ({{case.recurring_date}}){% endif %}</span>
        </div>
        {% endif %}
    </div>

    {% if config.SHOW_GDPR_NOTICE %}
    <div class="alert alert-info d-flex align-items-center py-2 px-3 mt-3 w-auto" style="font-size: 0.875rem; max-width: fit-content;">
        <i class="fa-solid fa-info-circle me-2"></i>
        <span>{{ config.GDPR_NOTICE }}</span>
    </div>
    {% endif %}

    <!-- Description (collapsible) -->
    {% if case.description %}
    <div class="case-description-section">
        <button class="btn btn-link btn-sm case-description-toggle" type="button" 
                data-bs-toggle="collapse" data-bs-target="#collapseDescription" 
                aria-expanded="true" aria-controls="collapseDescription">
            <i class="fa-solid fa-chevron-down"></i> Description
        </button>
        <div class="collapse show" id="collapseDescription">
            <pre class="case-description" v-if="cases_info" v-html="md.render(cases_info.case.description)"></pre>
        </div>
    </div>
    {% endif %}
</div>

<div class="case-core-style mt-4" id="case-main-nav">
    <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" 
            data-bs-target="#collapseTags" aria-expanded="true" aria-controls="collapseTags"
            style="float: right;">
        <i class="fa-solid fa-chevron-up fa-sm"></i>
    </button>
    <ul class="nav nav-tabs" style="margin-bottom: 10px;">
        <li class="nav-item">
            <button class="nav-link active" id="tab-main" aria-current="page" @click="active_tab('main')" style="min-width: 100px;">
                <i class="fa-solid fa-house fa-sm"></i>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-notes" @click="active_tab('notes')">
                <i class="fa-solid fa-note-sticky fa-sm me-1"></i><span class="section-title fs-6">Notes</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-misp-objects" @click="active_tab('misp-objects')">
                <i class="fa-solid fa-cubes fa-sm me-1"></i><span class="section-title fs-6">MISP-objects </span> 
                <span class="badge text-bg-secondary d-none" id="id-nb-misp-object">[[nb_misp_objects]]</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-connectors" @click="active_tab('connectors')">
                <i class="fa-solid fa-plug fa-sm me-1"></i><span class="section-title fs-6">Connectors </span>
                <span class="badge text-bg-secondary d-none" id="id-nb-connectors">[[case_connectors_list.length]]</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-files" @click="active_tab('files')">
                <i class="fa-solid fa-file fa-sm me-1"></i>Files
                <span class="badge text-bg-secondary" v-if="case_files_list.length > 0">[[case_files_list.length]]</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-history" @click="active_tab('history')"><i class="fa-solid fa-clock-rotate-left fa-sm me-1"></i>History</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-info" @click="active_tab('info')">
                <i class="fa-solid fa-circle-info fa-sm me-1"></i><span class="section-title fs-6">Info</span>
            </button>
        </li>
    </ul>

    <hr class="fading-line-2">

    <!-- Modal add new link -->
    <div class="modal fade" id="add_new_link" tabindex="-1" aria-labelledby="add_new_link_modal" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="add_new_link_modal">Add New link</h1>
                    <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Link to:
                    <select class="new-link-ajax" name="link_to" tabindex="-1" multiple data-placeholder="Link To"></select>
                    <div style="color: brown;" id="add_new_link_error"></div>
                </div>
                <div class="modal-footer">
                    <button @click="submit_add_new_link()" class="btn btn-primary">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <div class="collapse show" id="collapseTags">
        <template v-if="main_tab == 'main'">
            <div class="row">
                <div class="col">
                    <tags_edition v-if="cases_info" :current_case="cases_info.case" :type_object="'case'" :can_edit="can_edit_case"></tags_edition>

                    <div class="case-tags-style mt-2" v-if="cases_info">
                        <div class="justify-content-center" style="float: right">
                            <button v-if="can_edit_case" class="btn btn-primary btn-sm me-1" title="New link" data-bs-toggle="modal" data-bs-target="#add_new_link">
                                <i class="fa-solid fa-paperclip fa-sm"></i>+
                            </button>
                            <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#collapseLinks" aria-expanded="true" aria-controls="collapseLinks">
                                <i class="fa-solid fa-chevron-up fa-sm"></i>
                            </button>
                        </div>
                        <div class="d-flex align-items-center">
                            <h6 class="section-title mb-0"><i class="fa-solid fa-link fa-sm me-2"></i>Linked Cases</h6>
                            <span class="badge text-bg-secondary ms-2">[[cases_info.case.link_to.length]]</span>
                        </div>
                        <hr class="fading-line-2 mt-2 mb-2">
                        <div class="collapse show" id="collapseLinks">
                            <div class="row mt-2">
                                <div class="col-6 link-style-first" v-for="case_link in cases_info.case.link_to">
                                    <a :href="`/case/${case_link.id}`" class="ms-4 text-decoration-none text-reset p-1">
                                        [[case_link.title]]
                                    </a>
                                    <button class="btn btn-outline-danger btn-sm ms-4"
                                    @click="remove_case_link(cases_info, case_link)"
                                    title="Remove link from case">
                                        <i class="fa-solid fa-trash fa-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="case-tags-style">
                        <div class="d-flex align-items-center">
                            <h6 class="section-title mb-0"><i class="fa-solid fa-chart-pie fa-sm me-2"></i>Completion</h6>
                            <small class="ms-3 text-muted">
                                <a href="javascript:void(0)" @click="change_status_sort(true)" class="text-decoration-none">[[open_closed.open]] open</a> / 
                                <a href="javascript:void(0)" @click="change_status_sort(false)" class="text-decoration-none">[[open_closed.closed]] closed</a>
                            </small>
                        </div>
                        <hr class="fading-line-2 mt-2 mb-2">
                        <div class="progress mt-1" role="progressbar" aria-label="Basic example" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            <div v-if="open_closed.closed > 0"  class="progress-bar" :style="{'width': get_completion_pourcentage() +'%', 'background-color': get_completion_color()}">
                                [[get_completion_pourcentage()]]%
                            </div>
                            <div v-else class="progress-bar" style="width: 0%"></div>
                            <span v-if="open_closed.closed <= 0" class="position-absolute" style="margin-left: 5px; margin-top:-1px">0%</span>
                        </div>
                    </div>

                    <manage_orgs :cases_info="cases_info"></manage_orgs>
                </div>
            </div>
        </template>

        <template v-else-if="main_tab == 'history'">
            <case_history :case_id="cases_info.case.id" :can_view_history="{{ 'true' if current_user.is_admin() or current_user.is_case_admin() or current_user.is_audit_viewer() else 'false' }}"></case_history>
        </template>

        <template v-else-if="main_tab == 'notes'">
            <ul class="nav nav-tabs" style="margin-bottom: 10px;">
				<li class="nav-item">
					<button class="nav-link active" id="subtab-case-note" aria-current="page" @click="active_subtab_note('case')">
						<i class="fa-solid fa-briefcase fa-sm me-1"></i><span class="section-title">Case</span>
					</button>
				</li>
				<li class="nav-item">
					<button class="nav-link" id="subtab-template-note" @click="active_subtab_note('template')">
						<i class="fa-solid fa-file-lines fa-sm me-1"></i><span class="section-title">Template</span>
					</button>
				</li>
				<li class="nav-item">
					<button class="nav-link" id="subtab-hedgedoc" @click="active_subtab_note('hedgedoc')">
						<i class="fa-solid fa-file-code fa-sm me-1"></i><span class="section-title">Hedgedoc</span>
					</button>
				</li>
                <li class="nav-item">
					<button class="nav-link" id="subtab-computer-assistate" @click="active_subtab_note('computer-assistate')">
						<i class="fa-solid fa-robot fa-sm me-1"></i><span class="section-title">Computer Assisted</span>
					</button>
				</li>
			</ul>


            <template v-if="subtab_note == 'case'">
                <div class="d-flex" v-if="cases_info.case.notes">
                    <template v-if="edit_mode">
                        <div style="margin-right: -10px;">
                            <button class="btn btn-primary" @click="save_note_case()">Save</button>
                        </div>
                        <div class="container-fluid" style="display: flex; width:90%">
                            <div class="note-editor" id="editor"></div>
                            <div class="markdown-render" v-html="md.render(note_editor_render)"></div>
                        </div>
                    </template>
                    <template v-else>
                        <div>
                            <button class="btn btn-primary mb-2" @click="edit_note()">
                                <small><i class="fa-solid fa-pen fa-fw"></i></small> Edit
                            </button>
                            <div class="btn-group">
                                <button class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    <small><i class="fa-solid fa-download fa-fw"></i></small> Export
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <button v-if="!is_exporting" class="btn btn-link" @click="export_notes(cases_info.case.id, 'pdf')" title="Export markdown as pdf">PDF</button>
                                        <button v-else class="btn btn-link" disabled>
                                            <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                                            <span role="status">Loading...</span>
                                        </button>
                                    </li>
                                    <li>
                                        <button v-if="!is_exporting" class="btn btn-link" @click="export_notes(cases_info.case.id, 'docx')" title="Export markdown as docx">DOCX</button>
                                        <button v-else class="btn btn-link" disabled>
                                            <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                                            <span role="status">Loading...</span>
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div v-html="md.render(cases_info.case.notes)" class="markdown-render-result container-fluid"></div>
                    </template>
                </div>
                <div v-else class="d-flex">
                    <div style="margin-right: -10px;">
                        <button class="btn btn-primary mb-2" @click="save_note_case()">Save</button>
                    </div>
                    <div class="container-fluid" style="display: flex; width:90%">
                        <div class="note-editor" id="editor"></div>
                        <div class="markdown-render" v-html="md.render(note_editor_render)"></div>
                    </div>
                </div>
            </template>
            <template v-else-if="subtab_note == 'template'">
                <note_from_template :cases_info="cases_info"></note_from_template>
            </template>
            <template v-else-if="subtab_note == 'hedgedoc'">
                <hedgedoc_template 
                    :cases_info="cases_info"
                    :status_info="status_info">
                </hedgedoc_template>
            </template>
            <template v-else-if="subtab_note == 'computer-assistate'">
                <computer_assistate_template :cases_info="cases_info"></computer_assistate_template>
            </template>

        </template>

        <template v-else-if="main_tab == 'misp-objects'">
            <misp_object :case_id="{{case.id}}" :cases_info="cases_info" @modif_misp_objects="(msg) => fetch_nb_misp_objects()"></misp_object>
        </template>

        <template v-else-if="main_tab == 'connectors'">
            <div v-if="cases_info">
                <caseconnectors 
                    :case_task_connectors_list="case_connectors_list"
                    :all_connectors_list="all_connectors_list"
                    :modules="modules"
                    :is_case="true"
                    :object_id="cases_info.case.id"
                    :cases_info="cases_info"
                    @case_connectors="(msg) => fetch_case_connectors()"
                    @task_connectors="">
                </caseconnectors>
            </div>
        </template>

        <template v-else-if="main_tab == 'files'">
            <div v-if="cases_info">
                <casefiles
                    :case_id="cases_info.case.id"
                    :case_files_list="case_files_list"
                    :cases_info="cases_info"
                    @files_change="(msg) => fetch_case_files()">
                </casefiles>
            </div>
        </template>

        <template v-else-if="main_tab == 'info'">
            <div class="row">
                <div class="col-auto">
                    <fieldset class="analyzer-select-case" style="text-align: center;">
                        <legend class="analyzer-select-case">Time required</legend>
                        <i>[[cases_info.case.time_required]]</i>
                    </fieldset>
                </div>
                <div class="col-auto">
                    <fieldset class="analyzer-select-case" style="text-align: center;">
                        <legend class="analyzer-select-case">Visibility</legend>
                        <i v-if="cases_info.case.is_private">Private</i>
                        <i v-else>Public</i>
                    </fieldset>
                </div>
                <div class="col-auto">
                    <fieldset class="analyzer-select-case" style="text-align: center;">
                        <legend class="analyzer-select-case">UUID</legend>
                        <i>[[cases_info.case.uuid]]</i>
                    </fieldset>
                </div>
            </div>
        </template>
    </div> <!-- Collapse  -->
</div> <!-- Case-core-style  -->

    
<hr class="fading-line-2 mt-4 mb-5">


<!-- ----- -->
<!-- Tasks -->
<!-- ----- -->

<div class="case-core-style" id="task-collapse" style="min-height: 60vh;">
    <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" 
            data-bs-target="#collapseTasks" aria-expanded="true" aria-controls="collapseTasks"
            style="float: right;">
        <i class="fa-solid fa-chevron-up fa-sm"></i>
    </button>

    <div class="row align-items-center">
        <div class="col-auto d-flex align-items-center">
            <h5 class="mb-0"><i class="fa-solid fa-list-check me-2"></i>Tasks</h5>
            {% if not current_user.read_only() and present_in_case or current_user.is_admin() %}
                <a href="/case/{{case.id}}/create_task" class="btn btn-primary btn-sm ms-3" title="Add new task">
                    <i class="fa-solid fa-plus fa-sm"></i>
                </a>
            {%endif%}
        </div>
        
        <div class="col-auto" v-cloak>
            <button v-if="is_open_cases" class="btn btn-outline-secondary btn-sm" @click="change_status_sort(false)" title="See Finished tasks">
                <i class="fa-solid fa-folder-closed fa-sm me-1"></i> <span class="badge text-bg-secondary">[[open_closed.closed]]</span> closed
            </button>
            <button v-else class="btn btn-outline-secondary btn-sm" @click="change_status_sort(true)" title="See Opened tasks">
                <i class="fa-solid fa-folder-open fa-sm me-1"></i> <span class="badge text-bg-secondary">[[open_closed.open]]</span> open
            </button>
        </div>

        <!-- Search bar -->
        <div class="col input-group w-auto">
            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalFilter">
                <i class="fa-solid fa-filter fa-sm"></i>
            </button>
            <input autocomplete="off" @input="onInput" type="search" class="form-control form-control-sm rounded" placeholder='Search task by title' />
        </div>
        <!-- Search bar -->
    </div>

    <div class="modal fade" id="modalFilter" tabindex="-1" aria-labelledby="modalFilterLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="modalFilterLabel">Tasks Filter</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex w-100 justify-content-between">
                        <div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="radioOther" id="radioOtherTitle" @click="sort_by_filter('title')" checked>
                                <label class="form-check-label" for="radioOtherTitle">Title</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="radioOther" id="radioOtherCreation" @click="sort_by_filter('creation_date')">
                                <label class="form-check-label" for="radioOtherCreation">Creation</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="radioOther" id="radioOrderAsc" @click="sort_by_filter('last_modif')">
                                <label class="form-check-label" for="radioOrderAsc">Last Modif</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="radioOther" id="radioOtherDeadLine" @click="sort_by_filter('deadline')">
                                <label class="form-check-label" for="radioOtherDeadLine">Deadline</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="radioOther" id="radioOtherStatus" @click="sort_by_filter('status_id')">
                                <label class="form-check-label" for="radioOtherStatus">Status</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="radioOther" id="radioOtherAssign" @click="sort_by_filter('assigned_tasks')">
                                <label class="form-check-label" for="radioOtherAssign">Assigned tasks</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="radioOther" id="radioOtherCurrentAssign" @click="sort_by_filter('my_assignment')">
                                <label class="form-check-label" for="radioOtherCurrentAssign">My assignment</label>
                            </div>
                        </div>

                        <div>
                            Change order
                            <div class="form-check form-switch" style="margin-left: 35%;">
                                <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault" @click="change_switch_check(true)">
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div>Taxonomies:</div>
                    <div class="d-flex w-100 justify-content-center">
                        <div style="display:flex">
                            <span style="margin-right: 10px">OR</span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="switchOperator" @click="change_switch_check(false,true)">
                                <label class="form-check-label" for="switchOperator">AND</label>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex;">
                        <template v-if="taxonomies">
                            <select data-placeholder="Taxonomies" class="select2-filter form-control" multiple name="filter_taxonomies_select" id="filter_taxonomies_select" >
                                <template v-for="taxonomy, key in taxonomies">
                                    <option :value="[[taxonomy]]">[[taxonomy]]</option>
                                </template>
                            </select>
                        </template>
                        
                        <template v-if="tags_list">
                            <select data-placeholder="Tags" class="select2-filter form-control" multiple name="filter_tags_select" id="filter_tags_select" >
                                <template v-for="(tags, taxo) in tags_list">
                                    <optgroup :label="[[taxo]]">
                                        <option :value="[[tag.name]]" v-for="tag in tags">[[tag.name]]</option>
                                    </optgroup>
                                </template>
                            </select>
                        </template>
                    </div>
                    <hr>

                    <div>Galaxies:</div>
                    <div class="d-flex w-100 justify-content-center">
                        <div style="display:flex">
                            <span style="margin-right: 10px">OR</span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="switchOperator" @click="change_switch_check(false, false, true)">
                                <label class="form-check-label" for="switchOperator">AND</label>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex;">
                        <template v-if="galaxies">
                            <select data-placeholder="Galaxies" class="select2-filter form-control" multiple name="filter_galaxies_select" id="filter_galaxies_select" >
                                <template v-for="galaxy, key in galaxies">
                                    <option :value="[[galaxy.name]]">[[galaxy.name]]</option>
                                </template>
                            </select>
                        </template>
                        
                        <template v-if="cluster_list">
                            <select data-placeholder="Cluster" class="select2-filter form-control" multiple name="filter_clusters_select" id="filter_clusters_select" >
                                <template v-for="(clusters, galaxy) in cluster_list">
                                    <optgroup :label="[[galaxy]]">
                                        <option :value="[[cluster.name]]" :title="cluster.description" v-for="cluster in clusters">[[cluster.tag]]</option>
                                    </optgroup>
                                </template>
                            </select>
                        </template>
                    </div>
                    
                    <hr>

                    <div>Custom Tags:</div>
                    <div>
                        <template v-if="custom_tags">
                            <select data-placeholder="Custom Tags" class="select2-filter form-control" multiple name="task_custom_tags_select" id="task_custom_tags_select" >
                                <template v-for="custom_tag, key in custom_tags">
                                    <option :value="[[custom_tag.name]]">[[custom_tag.name]]</option>
                                </template>
                            </select>
                        </template>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="collapse show" id="collapseTasks">
        <template v-if="cases_info && cases_info.tasks && status_info" >
            <ul class="nav nav-tabs" style="margin-bottom: 10px;">
                <li class="nav-item">
                    <button class="nav-link active" id="tab-tasks" @click="active_task_tab('main')" style="min-width: 100px;">
                        <i class="fa-solid fa-house"></i>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="tab-tasks-notes" @click="active_task_tab('tasks-notes')">Notes</button>
                </li>
                <!-- <li class="nav-item">
                    <button class="nav-link" id="tab-all" @click="active_tab('all')">Stats</button>
                </li> -->
            </ul>

            <hr class="fading-line-2 mb-4">

            <template v-if="tasks_tab == 'main'">
                <div id="list-container">
                    <template v-for="task, key in cases_info.tasks" :key="task.id">
                        <div :id="`task-${task.id}`" class="list-group" style="margin-bottom: 40px;">
                            <case_tasks :cases_info="cases_info" 
                                        :users_in_case="users_in_case" 
                                        :status_info="status_info" 
                                        :task="task" 
                                        :key_loop="key"
                                        :open_closed="open_closed"
                                        :md="md"
                                        :all_connectors_list="all_connectors_list"
                                        :task_modules="task_modules">
                            </case_tasks>
                        </div>
                    </template>
                </div>
            </template>
            <template v-else-if="tasks_tab == 'tasks-notes'">
                <template v-for="notes in all_notes">
                    <div class="all-tasks-notes" v-html="md.render(notes)"></div>
                </template>
            </template>
            
        </template>
        <template v-else>
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </template>
    </div>

    {% if not current_user.read_only() and present_in_case or current_user.is_admin() %}
    <span id="createTask" title="Create a new task">
        <a href="/case/{{case.id}}/create_task" class="btn btn-outline-primary" style="border-radius: 50px;">
            <i class="fa-solid fa-plus"></i>
        </a>
    </span>
    {%endif%}
</div>
{% endblock %}




{% block script %}
    <script type="module">
        const { createApp, ref, computed, nextTick, onMounted, watch } = Vue
        import case_tasks from '/static/js/case/case_tasks.js'
        import hedgedoc_template from '/static/js/case/hedgedoc_template.js'
        import action_buttons from '/static/js/case/action_buttons.js'
        import tags_edition from '/static/js/case/tags_edition.js'
        import manage_orgs from '/static/js/case/manage_orgs.js'
        import misp_object from '/static/js/case/misp_object.js'
        import caseconnectors from '/static/js/case/CaseConnectors.js'
        import casefiles from '/static/js/case/CaseFiles.js'
        import case_history from '/static/js/case/case_history.js'
        import note_from_template from '/static/js/case/note_from_template.js'
        import computer_assistate_template from '/static/js/case/computer_assistate_template.js'
        import {display_toast, message_list, create_message} from '/static/js/toaster.js'
        import {getTextColor, mapIcon} from '/static/js/utils.js'
        const { EditorView, basicSetup, languages } = window.CodeMirrorBundle;
        
        createApp({
            delimiters: ['[[', ']]'],
            components: {
                case_tasks,
                hedgedoc_template,
                action_buttons,
                tags_edition,
                manage_orgs,
                misp_object,
                caseconnectors,
                casefiles,
                case_history,
                note_from_template,
                computer_assistate_template
            },
            setup() {
                const cases_info = ref(null)
                const status_info = ref(null)
                const users_in_case = ref(null)
                const is_exporting = ref(false)
                let loc_tasks_list = []

                let current_filter = ""
                const search_query = ref('')
                let searchTimer = null
                let asc_desc = true
                let or_and_taxo = true
                let or_and_galaxies = true

                const is_open_cases = ref(true)

                const main_tab = ref('main')
                const subtab_note = ref('case')
                const tasks_tab = ref('main')

                const taxonomies = ref([])
                const tags_list = ref([])
                const selected_taxo = ref([])
                const selected_tags = ref([])

                const galaxies = ref([])
                const cluster_list = ref([])
                const selected_galaxies = ref([])
                const selected_clusters = ref([])

                const custom_tags = ref([])
                const selected_custom_tags = ref([])

                const case_connectors_list = ref([])
                const all_connectors_list = ref([])
                const modules = ref()
                const task_modules = ref()

                const case_files_list = ref([])

                const nb_misp_objects = ref(0)

                const open_closed = ref({})
                const all_notes = ref("")
                let editor
                const note_editor_render = ref("")
                // Re-run mermaid on live-preview updates (editing mode)
                watch(note_editor_render, async () => {
                    await nextTick()
                    try{
                        // run mermaid only inside the preview container
                        md.mermaid.run({ querySelector: '.markdown-render .mermaid' })
                    }catch(e){}
                })
                const edit_mode = ref(false)

                const md = window.markdownit()			// Library to Parse and display markdown
		        md.use(mermaidMarkdown.default)			// Use mermaid library

                const case_for_link = ref([])


                async function fetch_open_closed(){
                    const res = await fetch("/case/get_open_close/"+cases_info.value.case.id)
                    if(await res.status==404 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        open_closed.value = loc
                    }
                }

                async function fetch_case_connectors(){
                    const res = await fetch("/case/"+ window.location.pathname.split("/").slice(-1) +"/get_case_connectors")
                    if(await res.status==404 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        case_connectors_list.value = loc["case_connectors"]
                    }
                }
                async function fetch_case_files(){
                    const res = await fetch("/case/"+ window.location.pathname.split("/").slice(-1) +"/get_case_info")
                    if(await res.status==404 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        case_files_list.value = loc["files"]
                    }
                }
                async function fetch_connectors(){
                    const res = await fetch("/case/get_connectors")
                    if(await res.status==404 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        all_connectors_list.value = loc["connectors"]
                    }
                }
                fetch_connectors()

                async function fetch_modules(){
                    // Get modules and instances linked on
                    const res = await fetch("/case/get_case_modules")
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        modules.value = loc["modules"]
                    }
                }
                fetch_modules()

                async function fetch_task_modules(){
                    // Get modules and instances linked on
                    const res = await fetch("/case/get_task_modules")
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        task_modules.value = loc["modules"]
                    }
                }
                fetch_task_modules()

                async function export_notes(case_id, type){
                    // Export notes in different format and download it
                    is_exporting.value = true
                    let filename = ""
                    await fetch('/case/'+case_id+'/export_notes?type=' + type)
                    .then(res =>{
                        filename = res.headers.get("content-disposition").split("=")
                        filename = filename[filename.length - 1]
                        return res.blob() 
                    })
                    .then(data =>{
                        var a = document.createElement("a")
                        a.href = window.URL.createObjectURL(data);
                        a.download = filename;
                        a.click();
                    })
                    is_exporting.value = false
                }

                async function change_status_sort(status){
                    is_open_cases.value = status
                    await fetch_sorted_tasks()
                }

                function change_switch_check(change=false, changeOperator=false, changeOperatorGalaxies=false){
                    if (change) asc_desc = !asc_desc
                    if (changeOperator) or_and_taxo = !or_and_taxo
                    if (changeOperatorGalaxies) or_and_galaxies = !or_and_galaxies

                    fetch_sorted_tasks()
                }

                async function fetch_sorted_tasks() {
                    let loc_status = `status=${!is_open_cases.value}`
                    let loc_filter = `&filter=${current_filter}`
                    let loc_or_and_taxo = `&or_and_taxo=${or_and_taxo}`
                    let loc_or_and_galaxies = `&or_and_galaxies=${or_and_galaxies}`

                    let tags = ""
                    let taxo = ""
                    let galax = ""
                    let clusters = ""
                    let custom_tg = ""
                    if(selected_tags.value.length) tags = "&tags=" + JSON.stringify(selected_tags.value)
                    if(selected_taxo.value.length) taxo = "&taxonomies=" + JSON.stringify(selected_taxo.value)
                    if(selected_galaxies.value.length) galax = "&galaxies=" + JSON.stringify(selected_galaxies.value)
                    if(selected_clusters.value.length) clusters = "&clusters=" + JSON.stringify(selected_clusters.value)
                    if(selected_custom_tags.value.length) custom_tg = "&custom_tags=" + JSON.stringify(selected_custom_tags.value)

                    let url = `/case/${cases_info.value.case.id}/sort_tasks?${loc_status}${loc_filter}${loc_or_and_taxo}${loc_or_and_galaxies}${tags}${taxo}${galax}${clusters}${custom_tg}`
                    if (search_query.value) url += '&q=' + encodeURIComponent(search_query.value)
                    
                    const res = await fetch(url)
                    let loc = await res.json()

                    if(asc_desc)
                        cases_info.value.tasks = loc.reverse()
                    else
                        cases_info.value.tasks = loc

                    loc_tasks_list = cases_info.value.tasks
                }

                function sort_by_filter(filter){
                    current_filter = filter
                    fetch_sorted_tasks()
                }


                async function fetchCase() {
                    cases_info.value = null
                    const res = await fetch(
                        window.location.pathname.split("/").slice(-1)+'/get_case_info'
                    )

                    if(await res.status == 404){
                        display_toast(res)
                    }else{
                        cases_info.value = await res.json()
                        loc_tasks_list = cases_info.value.tasks
                        await nextTick()
                        scrollIntoSelectedElement()
                        fetch_open_closed()
                        fetch_nb_misp_objects()

                        $('.select2-select-add-orgs').select2({
                            theme: 'bootstrap-5',
                            width: '50%'
                        })
                    }
                }
                

                async function fetchStatus() {
                    status_info.value = null
                    const res = await fetch(
                        '/case/get_status'
                    )
                    status_info.value = await res.json()
                }
                fetchStatus()

                async function get_all_users_case(){
                    users_in_case.value = null
                    const res = await fetch('/case/' + window.location.pathname.split("/").slice(-1) + '/get_all_users')
                    if(await res.status == 404){
                        display_toast(res)
                    }else{
                        users_in_case.value = await res.json()
                    }
                }
                get_all_users_case()

                function onInput(e){
                    clearTimeout(searchTimer)
                    search_query.value = e.target.value
                    searchTimer = setTimeout(() => fetch_sorted_tasks(), 300)
                }

                function scrollIntoSelectedElement() {
                    const url = new URL(location.href)
                    const task_id = url.hash.slice(1)
                    if(task_id){
                        const taskElem = document.getElementById(`${task_id}`)
                        if (taskElem) {
                            taskElem.scrollIntoView({ behavior: "smooth" });
                        }
                    }
                }

                async function prepare_editor(default_text){
                    const targetElement = document.getElementById('editor')
                    if(targetElement && targetElement.innerHTML === ""){
                        editor = new EditorView({
                            doc: default_text,
                            extensions: [basicSetup, languages.markdown(),EditorView.updateListener.of((v) => {
                                if (v.docChanged) {
                                    note_editor_render.value = editor.state.doc.toString()
                                }
                            })],
                            parent: targetElement
                        })
                    }
                    await nextTick()
                    md.mermaid.init()
                }

                async function fetch_all_notes(){
                    const res = await fetch("/case/"+cases_info.value.case.id+"/all_notes")
                    let loc = await res.json()
                    all_notes.value = loc["notes"]
                }

                async function active_tab(tab_name){
                    if(tab_name == 'main'){
                        main_tab.value = 'main'
                        if ( !document.getElementById("tab-main").classList.contains("active") ){
                            document.getElementById("tab-main").classList.add("active")
                            document.getElementById("tab-history").classList.remove("active")
                            document.getElementById("tab-notes").classList.remove("active")
                            document.getElementById("tab-misp-objects").classList.remove("active")
                            document.getElementById("tab-info").classList.remove("active")
                            document.getElementById("tab-connectors").classList.remove("active")
                            document.getElementById("tab-files").classList.remove("active")
                            await nextTick()

                            initialize_select2()
                        }
                    }else if(tab_name == 'history'){
                        main_tab.value = 'history'
                        if ( !document.getElementById("tab-history").classList.contains("active") ){
                            document.getElementById("tab-history").classList.add("active")
                            document.getElementById("tab-main").classList.remove("active")
                            document.getElementById("tab-notes").classList.remove("active")
                            document.getElementById("tab-misp-objects").classList.remove("active")
                            document.getElementById("tab-info").classList.remove("active")
                            document.getElementById("tab-connectors").classList.remove("active")
                            document.getElementById("tab-files").classList.remove("active")
                        }
                    }else if(tab_name == 'notes'){
                        let loc_tab = main_tab.value 
                        main_tab.value = 'notes'
                        if ( !document.getElementById("tab-notes").classList.contains("active") ){
                            document.getElementById("tab-notes").classList.add("active")
                            document.getElementById("tab-main").classList.remove("active")
                            document.getElementById("tab-history").classList.remove("active")
                            document.getElementById("tab-misp-objects").classList.remove("active")
                            document.getElementById("tab-info").classList.remove("active")
                            document.getElementById("tab-connectors").classList.remove("active")
                            document.getElementById("tab-files").classList.remove("active")
                        }
                        await nextTick()
                        if(!cases_info.value.case.notes && loc_tab != 'notes'){
                            prepare_editor("\n\n")
                        }else{
                            prepare_editor(cases_info.value.case.notes)
                        }
                    }else if(tab_name == 'misp-objects'){
                        main_tab.value = 'misp-objects'
                        if ( !document.getElementById("tab-misp-objects").classList.contains("active") ){
                            document.getElementById("tab-misp-objects").classList.add("active")
                            document.getElementById("tab-main").classList.remove("active")
                            document.getElementById("tab-notes").classList.remove("active")
                            document.getElementById("tab-history").classList.remove("active")
                            document.getElementById("tab-info").classList.remove("active")
                            document.getElementById("tab-connectors").classList.remove("active")
                            document.getElementById("tab-files").classList.remove("active")
                        }
                        await nextTick()
                    }else if(tab_name == 'connectors'){
                        main_tab.value = 'connectors'
                        if ( !document.getElementById("tab-connectors").classList.contains("active") ){
                            document.getElementById("tab-connectors").classList.add("active")
                            document.getElementById("tab-main").classList.remove("active")
                            document.getElementById("tab-notes").classList.remove("active")
                            document.getElementById("tab-history").classList.remove("active")
                            document.getElementById("tab-info").classList.remove("active")
                            document.getElementById("tab-misp-objects").classList.remove("active")
                            document.getElementById("tab-files").classList.remove("active")
                        }
                        await nextTick()
                    }else if(tab_name == 'files'){
                        main_tab.value = 'files'
                        if ( !document.getElementById("tab-files").classList.contains("active") ){
                            document.getElementById("tab-files").classList.add("active")
                            document.getElementById("tab-main").classList.remove("active")
                            document.getElementById("tab-notes").classList.remove("active")
                            document.getElementById("tab-history").classList.remove("active")
                            document.getElementById("tab-info").classList.remove("active")
                            document.getElementById("tab-misp-objects").classList.remove("active")
                            document.getElementById("tab-connectors").classList.remove("active")
                        }
                        await nextTick()
                    }else if(tab_name == 'info'){
                        main_tab.value = 'info'
                        if ( !document.getElementById("tab-info").classList.contains("active") ){
                            document.getElementById("tab-info").classList.add("active")
                            document.getElementById("tab-misp-objects").classList.remove("active")
                            document.getElementById("tab-main").classList.remove("active")
                            document.getElementById("tab-notes").classList.remove("active")
                            document.getElementById("tab-history").classList.remove("active")
                            document.getElementById("tab-connectors").classList.remove("active")
                            document.getElementById("tab-files").classList.remove("active")
                        }
                    }
                }

                async function active_subtab_note(tab_name) {
                    if(tab_name == 'case'){
                        let loc_tab = subtab_note.value 
                        subtab_note.value = tab_name
                        if ( !document.getElementById("subtab-case-note").classList.contains("active") ){
                            document.getElementById("subtab-case-note").classList.add("active")
                            document.getElementById("subtab-template-note").classList.remove("active")
                            document.getElementById("subtab-hedgedoc").classList.remove("active")
                            document.getElementById("subtab-computer-assistate").classList.remove("active")
                        }
                        await nextTick()
                        if(!cases_info.value.case.notes && loc_tab != 'case'){
                            prepare_editor("\n\n")
                        }else{
                            prepare_editor(cases_info.value.case.notes)
                        }
                    }else if(tab_name == 'template'){
                        subtab_note.value = tab_name
                        if ( !document.getElementById("subtab-template-note").classList.contains("active") ){
                            document.getElementById("subtab-template-note").classList.add("active")
                            document.getElementById("subtab-case-note").classList.remove("active")
                            document.getElementById("subtab-hedgedoc").classList.remove("active")
                            document.getElementById("subtab-computer-assistate").classList.remove("active")
                        }
                        await nextTick()
                        md.mermaid.init()
                    }else if(tab_name == 'hedgedoc'){
                        subtab_note.value = tab_name
                        if ( !document.getElementById("subtab-hedgedoc").classList.contains("active") ){
                            document.getElementById("subtab-hedgedoc").classList.add("active")
                            document.getElementById("subtab-case-note").classList.remove("active")
                            document.getElementById("subtab-template-note").classList.remove("active")
                            document.getElementById("subtab-computer-assistate").classList.remove("active")
                        }
                        await nextTick()
                        md.mermaid.init()
                    }else if(tab_name == 'computer-assistate'){
                        subtab_note.value = tab_name
                        if ( !document.getElementById("subtab-computer-assistate").classList.contains("active") ){
                            document.getElementById("subtab-computer-assistate").classList.add("active")
                            document.getElementById("subtab-case-note").classList.remove("active")
                            document.getElementById("subtab-template-note").classList.remove("active")
                            document.getElementById("subtab-hedgedoc").classList.remove("active")
                        }
                        await nextTick()
                        md.mermaid.init()
                    }
                }

                async function active_task_tab(tab_name){
                    if(tab_name == 'main'){
                        tasks_tab.value = tab_name
                        if ( !document.getElementById("tab-tasks").classList.contains("active") ){
                            document.getElementById("tab-tasks").classList.add("active")
                            document.getElementById("tab-tasks-notes").classList.remove("active")
                        }
                    }else if(tab_name == 'tasks-notes'){
                        tasks_tab.value = tab_name
                        if ( !document.getElementById("tab-tasks-notes").classList.contains("active") ){
                            document.getElementById("tab-tasks-notes").classList.add("active")
                            document.getElementById("tab-tasks").classList.remove("active")
                        }
                        await fetch_all_notes()
                        await nextTick()
                        md.mermaid.init()
                    }
                }


                async function fetch_taxonomies(){
                    const res = await fetch("/case/get_taxonomies")
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        taxonomies.value = loc["taxonomies"]
                    }
                }
                fetch_taxonomies()

                async function fetch_galaxies(){
                    const res = await fetch("/case/get_galaxies")
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        galaxies.value = loc["galaxies"]
                    }
                }
                fetch_galaxies()

                async function fetch_tags(){
                    const res = await fetch("/case/get_tags?taxonomies=" + JSON.stringify(selected_taxo.value))
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        tags_list.value = loc["tags"]
                        $('#tags_select').trigger('change');
                    }
                }
                async function fetch_cluster(){
                    const res = await fetch("/case/get_clusters?galaxies=" + JSON.stringify(selected_galaxies.value))
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        cluster_list.value = loc["clusters"]
                        $('#clusters_select').trigger('change');
                    }
                }

                async function fetch_custom_tags(){
                    const res = await fetch("/custom_tags/list")
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        custom_tags.value = loc
                    }                    
                }
                fetch_custom_tags()

                async function save_note_case(){
                    let notes_loc = editor.state.doc.toString()
                    if(notes_loc.trim().length == 0){
                        notes_loc = notes_loc.trim()
                    }
                    const res_msg = await fetch(
                        '/case/' + cases_info.value.case.id + '/modif_note_case',{
                            headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                            method: "POST",
                            body: JSON.stringify({"notes": notes_loc})
                        }
                    )
                    if(await res_msg.status == 200){
                        edit_mode.value = false
                        cases_info.value.case.last_modif = Date.now()
                        cases_info.value.case.notes = notes_loc
                        await nextTick()
                        
                        if(!notes_loc){
                            prepare_editor("\n\n")
                        }
                        md.mermaid.init()
                    }
                    await display_toast(res_msg)
                }

                async function edit_note(){
                    // Edit the note of the task
                    edit_mode.value = true
                    await nextTick()
                    
                    note_editor_render.value = cases_info.value.case.notes
                    prepare_editor(cases_info.value.case.notes)
                    
                }

                function initialize_select2(){
                    $('.select2-filter').select2({
                        theme: 'bootstrap-5',
                        width: '50%',
                        closeOnSelect: false
                    })


                    $('#filter_taxonomies_select').on('change', function (e) {
                        selected_taxo.value = $(this).select2('data').map(item => item.id);
                        fetch_tags()
                    })

                    $('#filter_tags_select').on('change', function (e) {
                        selected_tags.value = $(this).select2('data').map(item => item.id);
                        fetch_sorted_tasks()
                    })
                    $('#filter_galaxies_select').on('change', function (e) {
                        selected_galaxies.value = $(this).select2('data').map(item => item.id);
                        fetch_cluster()
                    })
                    $('#filter_clusters_select').on('change', function (e) {
                        selected_clusters.value = $(this).select2('data').map(item => item.id);
                        fetch_sorted_tasks()
                    })

                    $('#task_custom_tags_select').on('change', function (e) {
                        selected_custom_tags.value = $(this).select2('data').map(item => item.id);
                        fetch_sorted_tasks()
                    })
                }

                async function autosave_case_note(){
                    if (edit_mode.value){
                        let notes_loc = editor.state.doc.toString()
                        if(notes_loc.trim().length == 0){
                            notes_loc = notes_loc.trim()
                        }
                        const res_msg = await fetch(
                            '/case/' + cases_info.value.case.id + '/modif_note_case',{
                                headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                                method: "POST",
                                body: JSON.stringify({"notes": notes_loc})
                            }
                        )
                        if(await res_msg.status == 200){
                            cases_info.value.case.notes = notes_loc
                        }
                    }
                    setTimeout(autosave_case_note, 30000);
                }

                async function submit_add_new_link() {    
                    $("#add_new_link_error").text("")
                    if($(".new-link-ajax").val().includes("None") || !$(".new-link-ajax").val().length){
                        $("#add_new_link_error").text("Give me more")
                    }else{
                        const res = await fetch('/case/' + cases_info.value.case.id + '/add_new_link',{
                            headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                            method: "POST",
                            body: JSON.stringify({"case_id": $(".new-link-ajax").val()})
                        })
                        if(await res.status == 200){
                            let loc = $(".new-link-ajax").val()
                            for(let index in loc){
                                for(let i in case_for_link.value){
                                    if(case_for_link.value[i].id == loc[index]){
                                        cases_info.value.case.link_to.push({"id":case_for_link.value[i].id, "title": case_for_link.value[i].text})
                                    }
                                }
                            }
                            var myModalEl = document.getElementById('add_new_link');
                            var modal = bootstrap.Modal.getInstance(myModalEl)
                            modal.hide();
                        }
                        display_toast(res)
                    }
                }

                async function remove_case_link(cases_info, case_loc){
                    const res = await fetch('/case/' + cases_info.case.id + '/remove_case_link/' + case_loc.id)
                    if (await res.status == 200){
                        let index = cases_info.case.link_to.indexOf(case_loc)
                        if(index > -1)
                            cases_info.case.link_to.splice(index, 1)
                    }
                    display_toast(res)
                }

                async function fetch_nb_misp_objects() {
                    const res = await fetch('/case/{{case.id}}/nb_objects')
                    if (await res.status == 200){
                        let loc = await res.json()
                        nb_misp_objects.value = loc["nb_objects"]
                    }
                }

                function get_completion_pourcentage(){
                    return Math.round((open_closed.value.closed / (open_closed.value.open + open_closed.value.closed) )*100)
                }

                function get_completion_color(){
                    const percentage = get_completion_pourcentage()
                    if (percentage >= 100) {
                        return '#28a745' // Fully green
                    } else if (percentage >= 75) {
                        return '#82c91e' // Closer to green
                    } else if (percentage >= 25) {
                        return '#ffc107' // Amber
                    } else if (percentage >= 1) {
                        return '#ff9800' // Amber closer to red
                    } else {
                        return '#e0e0e0' // Gray for 0%
                    }
                }

                onMounted( async () => {
                    await fetchCase()
                    initialize_select2()
                    autosave_case_note()
                    fetch_case_connectors()
                    fetch_case_files()

                    $('.new-link-ajax').select2({
                        ajax: {
                            url: '/case/search',
                            data: function (params) {
                                var query = {
                                    text: params.term
                                }
                                submit_add_new_link
                                // Query parameters will be ?text=[term]
                                return query;
                            },
                            processResults: function (data) {
                                case_for_link.value = []
                                for(let i in data.cases){
                                    case_for_link.value.push({id: data.cases[i].id, text: data.cases[i].title})
                                }
                                
                                return {
                                    results: case_for_link.value
                                };
                            }
                        },
                        minimumInputLength: 1,
                        width: "50%",
                        dropdownParent: $('#add_new_link')
                    });

                    $("#id-nb-connectors").removeClass("d-none")
                    $("#id-nb-misp-object").removeClass("d-none")
                    // $("#id-case-status").removeClass("d-none")

                    const collapseEl = document.getElementById('collapseTasks');
                    const parentEl = document.getElementById('task-collapse');

                    collapseEl.addEventListener('shown.bs.collapse', function () {
                        parentEl.style.minHeight = '60vh'; // light blue
                    });

                    collapseEl.addEventListener('hidden.bs.collapse', function () {
                        parentEl.style.minHeight = '0'; // reset
                    });



                    const options = {
                        animation: 150,
                        handle: '.list-group-item', // Only drag by header
                        ghostClass: 'dragging-ghost',  // class applied to the clone while dragging
                        onEnd: async function(evt) {
                            let task
                            for(let i in cases_info.value.tasks){
                                if (cases_info.value.tasks[i].id == evt.item.id.split("-")[1]){
                                    task = cases_info.value.tasks[i]
                                    break
                                }
                            }
                            if(!task.completed){
                                if(evt.newIndex != evt.oldIndex){
                                    const dataToSend = {"new-index": evt.newIndex}

                                    // Send via fetch to backend
                                    const res = await fetch('/case/'+cases_info.value.case.id+'/change_order/'+evt.item.id.split("-")[1], {
                                        method: 'POST',
                                        headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                                        body: JSON.stringify(dataToSend)
                                    })
                                    if(await res.status == 200){
                                        // let task = cases_info.value.tasks.find(t => t.id === evt.item.id.split("-")[1]);
                                        
                                        // Sort tasks by case_order_id ascending
                                        let tasks = cases_info.value.tasks

                                        // Find the task whose case_order_id matches new-index + 1
                                        const newIndex = evt.newIndex
                                        const target_task = tasks.find(t => t.case_order_id === newIndex + 1);

                                        const moving_task = task;

                                        // Find target index in the sorted array
                                        const target_index = tasks.indexOf(target_task);

                                        // Remove moving_task from array
                                        const movingIndex = tasks.indexOf(moving_task);
                                        if (movingIndex !== -1) {
                                        tasks.splice(movingIndex, 1);
                                        }

                                        // Insert moving_task before target_index
                                        tasks.splice(target_index, 0, moving_task);

                                        // Reassign case_order_id starting at 1
                                        tasks.forEach((t, i) => {
                                            t.case_order_id = i + 1;
                                        });
                                    }
                                    display_toast(res)
                                }
                            }else{
                                create_message("Finished tasks cannot be moved", "warning-subtle",false)
                            }
                        }
                    };

                    const listContainer = document.getElementById('list-container');
                    if (listContainer) {
                        new Sortable(listContainer, options);
                    }
                })

                const can_edit_case = computed(() => {
                    if (!cases_info.value) return false
                    const permission = cases_info.value.permission
                    const present_in_case = cases_info.value.present_in_case

                    if (permission && permission.read_only) return false
                    if (permission && permission.admin) return true                    
                    if (present_in_case) return true
                    
                    return false
                })

                
    
                return {
                    cases_info,
                    status_info,
                    users_in_case,
                    message_list,
                    dayjs,
                    main_tab,
                    subtab_note,
                    tasks_tab,
                    is_exporting,
                    nb_misp_objects,
                    can_edit_case,
                    onInput,
                    sort_by_filter,
                    active_tab,
                    active_subtab_note,
                    active_task_tab,
                    submit_add_new_link,
                    remove_case_link,
                    getTextColor,
                    mapIcon,
                    taxonomies,
                    tags_list,
                    galaxies,
                    cluster_list,
                    custom_tags,
                    open_closed,
                    md,
                    all_notes,
                    note_editor_render,
                    edit_mode,
                    case_connectors_list,
                    all_connectors_list,
                    modules,
                    task_modules,
                    case_files_list,
                    save_note_case,
                    edit_note,
                    export_notes,
                    fetch_case_connectors,
                    fetch_case_files,

                    change_status_sort,
                    change_switch_check,
                    fetch_sorted_tasks,

                    fetch_nb_misp_objects,

                    get_completion_pourcentage,
                    get_completion_color,
                    is_open_cases
                }
            }
        }).mount('#main-container')

    </script>
{% endblock %}