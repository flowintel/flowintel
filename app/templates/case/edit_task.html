<!-- 
    Author: David Cruciani
-->
{% extends 'base.html' %}
{% import 'macros/form_macros.html' as f %}

{% block head %}
<script src="{{ url_for('static',filename='js/vendor/codemirror.js') }}"></script>

<title>Edit task #{{ task_id }} - Case #{{ case_id }} - {{ config.APP_NAME }}</title>
{{ super() }}
{%endblock%}


{% block content %}

    <h2 class="ui dividing header case-core-style" style="border-radius: 0;">Edit task #{{ task_id }} (Case #{{ case_id }})</h2>
    <hr class="fading-line-2 mb-4 mt-4">

    <form action="" method="post" id="form" class="case-core-style" novalidate>
        {{ form.hidden_tag() }}
        <div class="row">
            <div class="mb-3 w-50">
                <i class="fa-solid fa-heading"></i> <strong>{{form.title.label(class_="col-form-label")}}:</strong> <span style="color: red;">*</span>
                {{form.title(class_="form-control", placeholder="Task title or description", id="task_title")}}
                <div id="title_error" style="color: red; display: none;">Title is required</div>
                {% if form.title.errors %}
                    <div style="color: red;">{{form.title.errors[0] | safe}}</div>
                {%endif%}
            </div>
            <div class="mb-3 w-50">
                <i class="fa-solid fa-hourglass-half"></i> <strong>{{form.time_required.label(class_="col-form-label")}}:</strong>
                {{form.time_required(class_="form-control", placeholder="How much time is required?")}}
                {% if form.time_required.errors %}
                    <div style="color: red;">{{form.time_required.errors[0] | safe}}</div>
                {%endif%}
            </div>
        </div>
        <div class="row">
            <div class="col">
                <i class="fa-solid fa-calendar"></i> <strong>{{form.deadline_date.label(class_="col-form-label")}}:</strong>
                {{form.deadline_date(class_="form-control", placeholder="When should this be completed")}}
                    {% if form.deadline_date.errors %}
                    <div style="color: red;">{{form.deadline_date.errors[0] | safe}}</div>
                {%endif%}
            </div>
            <div class="col">
                <i class="fa-solid fa-clock"></i> <strong>{{form.deadline_time.label(class_="col-form-label")}}:</strong>
                {{form.deadline_time(class_="form-control", placeholder="Specific time for the deadline")}}
                {% if form.deadline_time.errors %}
                    <div style="color: red;">{{form.deadline_time.errors[0] | safe}}</div>
                {%endif%}
            </div>
        </div>
        <div class="row">
            <span class="mb-2"><i class="fa-solid fa-file-lines"></i> <strong>Description:</strong></span>
            <div style="display: flex">
                <div class="note-editor" id="editor"></div>
                <div class="markdown-render" v-html="rendered_preview"></div>
                <textarea id="description" name="description" hidden :value="note_editor_render" type="text"></textarea>
            </div>
        </div>

        <hr style="margin-top: 40px; margin-bottom: 40px;">

        <edition_select 
            :type_object="'task'"
            @st="(msg) => selected_tags=selected_tags.concat(msg)"
            @sc="(msg) => selected_clusters=selected_clusters.concat(msg)"
            @sg="(msg) => selected_galaxies=selected_galaxies.concat(msg)"
            @sct="(msg) => selected_custom_tags=selected_custom_tags.concat(msg)"
            @delete_st="(msg) => selected_tags.splice(msg, 1)"
            @delete_sc="(msg) => selected_clusters.splice(msg, 1)"
            @delete_sg="(msg) => selected_galaxies.splice(msg, 1)"
            @delete_sct="(msg) => selected_custom_tags.splice(msg, 1)"
        >
        </edition_select>

        <div style="margin-top: 10px;">
            <button class="btn btn-primary" type="button" @click="submit_form()">Save</button>
            <a href="/case/{{ case_id }}" class="btn btn-secondary ms-2">Cancel</a>
        </div>
    </form>
{% endblock %}

{% block script %}
<script type="module">
    const { createApp, onMounted, nextTick, ref} = Vue
    import {message_list} from '/static/js/toaster.js'
    import edition_select from '/static/js/case/edition_select.js'
    import { renderMarkdownServer } from '/static/js/markdown_render.js'
    const { EditorView, basicSetup, languages } = window.CodeMirrorBundle;

    createApp({
        delimiters: ['[[', ']]'],
        components: {
            edition_select
        },
        setup() {
            const selected_tags = ref([])
            const selected_clusters = ref([])
            const selected_galaxies = ref([])
            const selected_custom_tags = ref([])

            let editor
            const description_content = `{{description | safe}}`
            const note_editor_render = ref(description_content)
            const rendered_preview = ref("")

            async function renderPreview() {
                if (!note_editor_render.value) {
                    rendered_preview.value = ""
                    return
                }
                rendered_preview.value = await renderMarkdownServer({ markdown: note_editor_render.value })
            }
            
            function submit_form(){
                // Validate title first
                const titleInput = document.getElementById('task_title');
                const titleError = document.getElementById('title_error');
                const titleValue = titleInput ? titleInput.value.trim() : '';
                
                if (!titleValue) {
                    titleError.style.display = 'block';
                    titleInput.focus();
                    return; // Stop - do not submit
                }
                titleError.style.display = 'none';
                
                // Add hidden inputs for tags, clusters, and custom tags
                $.each(selected_clusters.value, function(i, v){
                    var input = $("<input>").attr({"type":"hidden","name":"clusters_select"}).val(v.uuid);
                    $('#form').append(input);    
                });
                $.each(selected_tags.value, function(i, v){
                    var input = $("<input>").attr({"type":"hidden","name":"tags_select"}).val(v.name);
                    $('#form').append(input);    
                });
                $.each(selected_custom_tags.value, function(i, v){
                    var input = $("<input>").attr({"type":"hidden","name":"custom_select"}).val(v.name);
                    $('#form').append(input);    
                });
                $.each(selected_galaxies.value, function(i, v){
                    var input = $("<input>").attr({"type":"hidden","name":"galaxies_select"}).val(v.uuid);
                    $('#form').append(input);    
                });
                
                // Submit the form
                document.getElementById('form').submit();
            } 

            onMounted(() => {
                $('.select2-select').select2({
                    theme: 'bootstrap-5',
                    closeOnSelect: false
                })

                const targetElement = document.getElementById('editor')
                if(targetElement && targetElement.innerHTML === ""){
                    editor = new EditorView({
                        doc: description_content,
                        extensions: [basicSetup, languages.markdown(),EditorView.updateListener.of((v) => {
                            if (v.docChanged) {
                                note_editor_render.value = editor.state.doc.toString()
                                renderPreview()
                            }
                        })],
                        parent: targetElement
                    })
                }
                renderPreview()
            })

            return {
                message_list,

                selected_tags,
                selected_clusters,
                selected_galaxies,
                selected_custom_tags,

                note_editor_render,
                rendered_preview,

                submit_form
            }
        }
    }).mount('#main-container')

</script>
{% endblock %}