
	<!-- Navbar -->
<nav id="main-navbar" class="navbar navbar-expand-lg topbar" style="padding: 10px 0;">
    <!-- Container wrapper -->
    <div class="container-fluid">
        <!-- Toggle button -->
        <button id="sidebarToggleTop" role="button" class="btn btn-link d-md-none rounded-circle mr-3">
            <i class="fa fa-bars"></i>
        </button>

        <!-- Search form -->
        <div id="search-form" class="d-none">
            <div class="d-none d-md-flex input-group w-auto my-auto justify-content-center" id="search-form">
                <input autocomplete="off" @input="onInput" type="search" class="form-control rounded" placeholder='Search case by title' style="min-width: 350px;" />
            </div>
            <div v-if="result_search && result_search.length" class="search-result justify-content-center">
                <div v-for="case_search in result_search" style="margin-bottom: 2px;">
                    <i class="fa-solid fa-circle fa-2xs"></i>
                    <a v-if="case_search.description" :href="'/case/'+case_search.id" :title="case_search.description">[[case_search.title]]</a>
                    <a v-else :href="'/case/'+case_search.id" title="No description">[[case_search.title]]</a>
                </div>
            </div>
        </div>

        <!-- Right links -->
        <ul class="navbar-nav ms-auto d-flex flex-row">
            <!-- Notification dropdown -->
            <li class="nav-item dropdown">
                <a class="nav-link me-3 me-lg-0" href="/notification" id="notification_id">
                    <i class="fas fa-bell"></i>
                    <template v-if="notif_list && notif_list> 0">
                        <span v-if="notif_list < 100" class="position-absolute translate-middle badge rounded-pill bg-danger">[[notif_list]]</span>
                        <span v-else class="position-absolute translate-middle badge rounded-pill bg-danger">99+</span>
                    </template>
                </a>
            </li>

            <!-- Avatar -->
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle hidden-arrow d-flex align-items-center" href="#"
                    id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    {{current_user.first_name}} {{current_user.last_name}}
                    {% if current_user.is_admin() %}
                        <span class="badge bg-danger ms-2" title="Admin role">
                            <i class="fa-solid fa-shield-halved"></i>
                        </span>
                    {% elif current_user.read_only() %}
                        <span class="badge bg-info ms-2" title="Read Only role">
                            <i class="fa-solid fa-eye"></i>
                        </span>
                    {% else %}
                        <span class="badge bg-success ms-2" title="Editor role">
                            <i class="fa-solid fa-pen"></i>
                        </span>
                    {% endif %}
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownMenuLink">
                    <li>
                        <a class="dropdown-item" href="/account" id="account_id">My profile</a>
                    </li>
                    {% if current_user.is_authenticated %}
                        <li>
                            <a class="dropdown-item" href="/account/logout" id="logout_id">Logout</a>
                        </li>
                    {% endif %}
                </ul>
            </li>
        </ul>
    </div>
<!-- Container wrapper -->
</nav>

<script type="module">
	const { createApp, ref, computed, onMounted } = Vue
	import {display_toast, message_list} from '/static/js/toaster.js'

	createApp({
		delimiters: ['[[', ']]'],
		setup() {
			const result_search = ref([])
			const notif_list = ref(null)


			async function onInput(e){
				result_search.value = []
				if(e.target.value){
					const res = await fetch('/case/search?text='+e.target.value)
					if (await res.status == 200){
						let loc = await res.json()
						result_search.value = loc["cases"]
					}
					else{
						display_toast(res)
					}
				}
			}

			async function fetchNotif() {
				notif_list.value = null
				const res = await fetch('/notification/get_user_notifications_len')
				let loc = await res.json()
				notif_list.value = loc["notif"]
			}

			fetchNotif()

			// hide search result when click out 
			$(document).mouseup(function(e) {
				var container = $(".search-result");

				// if the target of the click isn't the container nor a descendant of the container
				if (!container.is(e.target) && container.has(e.target).length === 0) 
				{
					container.hide();
				}
			});

			
			onMounted(() => {
				$('#search-form').removeClass('d-none')

                document.getElementById("notification_id").addEventListener('click', function(){
                    localStorage.setItem("activePage", "");
                })
                document.getElementById("account_id").addEventListener('click', function(){
                    localStorage.setItem("activePage", "");
                })
                document.getElementById("logout_id").addEventListener('click', function(){
                    localStorage.setItem("activePage", "");
                })
			})

			return {
				onInput,
				result_search,
				notif_list,
				message_list
			}
		}
	}).mount('.navbar')
</script>
