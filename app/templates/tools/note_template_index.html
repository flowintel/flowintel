<!-- 
    Author: David Cruciani
-->

{% extends 'base.html' %}

{% block head %}
<script src="{{ url_for('static',filename='js/vendor/markdown-it.min.js') }}"></script>
<script src="{{ url_for('static',filename='js/vendor/codemirror.js') }}"></script>
<script src="{{ url_for('static',filename='js/mermaid-markdown.js') }}"></script>

{{ super() }}
{%endblock%}

{% block content %}
{% set can_manage_templates = current_user.is_admin() or current_user.is_template_editor() %}

<div class="case-core-style" style="border-radius: 0; margin-bottom: 10px;">
    <div class="row align-items-center">
        <div class="col-auto d-flex align-items-center">
            <h5 class="mb-0"><i class="fa-solid fa-note-sticky me-2"></i>Note Templates</h5>
            {% if can_manage_templates %}
                <a type="button" class="btn btn-primary btn-sm ms-3" href="/tools/create_note_template_view" title="Add new note template">
                    <i class="fa-solid fa-plus fa-sm"></i>
                </a>
            {% else %}
                <button type="button" class="btn btn-primary btn-sm ms-3" disabled title="You do not have permission to create templates">
                    <i class="fa-solid fa-plus fa-sm"></i>
                </button>
            {% endif %}
        </div>
    </div>
    {% if not can_manage_templates %}
        <div class="alert alert-warning py-1 px-2 mt-2 mb-0" role="alert">
            You do not have the Template Editor permissions and are not allowed to create or edit templates.
        </div>
    {% endif %}
</div>
<hr class="fading-line">

<!-- pagination -->
<nav aria-label="Page navigation" class="nav-pagination" v-if="notes_list && notes_list.nb_pages > 1">
    <ul class="pagination">
        <li :class="{'page-item': true, 'disabled': current_page == 1}">
            <button class="page-link" @click="fetchNoteTemplate(Math.max(1, current_page-1))">Previous</button>
        </li>
        <li v-for="page in visiblePages"
                :class="['page-time', {active: page === current_page, disabled: page === '...' }]">
                <button class="page-link" v-if="page !== '...'" @click="fetchNoteTemplate(page)">[[ page ]]</button>
                <span class="page-link" v-else>...</span>
            </li>
        <li :class="{'page-item': true, 'disabled': current_page == notes_list.nb_pages}">
            <button class="page-link" @click="fetchNoteTemplate(Math.min(current_page+1, notes_list.nb_pages))">Next</button>
        </li>
    </ul>
</nav>
<!-- pagination -->

<template v-if="notes_list">
    <template v-if="!notes_list.notes.length">
        <i>No Note Template</i>
    </template>
    <template v-else>
        <template v-for="note_loc, key in notes_list.notes" :key="note_loc.id">
            <div class="list-group" style="margin-bottom: 20px;">
                <note_template_component :note_template="note_loc" :key_loop="key" :notes_list="notes_list.notes" :can_edit="{{ 'true' if can_manage_templates else 'false' }}"></note_template_component>
            </div>
        </template>
    </template>
</template>
<template v-else>
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</template>

<nav aria-label="Page navigation" class="mt-3 nav-pagination" v-if="notes_list && notes_list.nb_pages > 1">
    <ul class="pagination">
        <li :class="{'page-item': true, 'disabled': current_page == 1}">
            <button class="page-link" @click="fetchNoteTemplate(Math.max(1, current_page-1))">Previous</button>
        </li>
        <li v-for="page in visiblePages"
                :class="['page-time', {active: page === current_page, disabled: page === '...' }]">
                <button class="page-link" v-if="page !== '...'" @click="fetchNoteTemplate(page)">[[ page ]]</button>
                <span class="page-link" v-else>...</span>
            </li>
        <li :class="{'page-item': true, 'disabled': current_page == notes_list.nb_pages}">
            <button class="page-link" @click="fetchNoteTemplate(Math.min(current_page+1, notes_list.nb_pages))">Next</button>
        </li>
    </ul>
</nav>
{% endblock %}

{% block script %}
    <script type="module">
        const { createApp, ref, computed } = Vue
        import note_template_component from '/static/js/tools/note_template_component.js'
        import {display_toast, message_list} from '/static/js/toaster.js'
        
        createApp({
            delimiters: ['[[', ']]'],
            components: {
                note_template_component
            },
            setup() {
                const notes_list = ref(null)
                const current_page = ref(1)

                async function fetchNoteTemplate(page) {
                    let url = '/tools/note_template/get_by_page?page='+page

                    current_page.value = page
                    notes_list.value = null
                    const res = await fetch(url)
                    let loc = await res.json()
                    notes_list.value = loc
                }
                
                fetchNoteTemplate(1)

                const visiblePages = computed(() => {
                    const pages = []
                    const total = notes_list.value.nb_pages
                    const current = current_page.value
                    if (total <= 7) {
                        for (let i = 1; i <= total; i++) pages.push(i)
                    } else {
                        if (current <= 4) {
                            pages.push(1, 2, 3, 4, 5, '...', total-1, total)
                        } else if (current >= total - 3) {
                            pages.push(1, '...', total - 4, total - 3, total - 2, total - 1, total)
                        } else {
                            pages.push(1, '...', current - 2, current - 1, current, current + 1, current + 2, '...', total)
                        }
                    }
                    return pages
                })

                return {
                    message_list, // Avoid warning
                    dayjs,

                    notes_list,
                    current_page,
                    visiblePages,
                    fetchNoteTemplate,
                }
            }
        }).mount('#main-container')

    </script>
{% endblock %}