<!-- 
    Author: David Cruciani
-->

{% extends 'base.html' %}

{% block head %}
<script src="{{ url_for('static',filename='js/vendor/markdown-it.min.js') }}"></script>
<script src="{{ url_for('static',filename='js/vendor/codemirror.js') }}"></script>
<script src="{{ url_for('static',filename='js/mermaid-markdown.js') }}"></script>

{{ super() }}
{%endblock%}


{% block content %}

  
  

<div class="case-core-style" style="border-radius: 0;" v-if="note_template">
    <div style="margin-bottom: 10px; display: flex; align-items: center;">
        <template v-if="!editing_header">
            <h4 class="mb-0"><span class="text-muted">{{note_template.id}}</span> - [[note_template.title]]</h4>
            <span><i style="font-size: 12px; margin-left: 10px;">{{note_template.uuid}}</i></span>
            <button class="btn btn-sm btn-primary ms-3" @click="edit_header()" title="Edit title and description">
                <i class="fa-solid fa-pen-to-square"></i>
            </button>
        </template>
        <template v-else>
            <div class="flex-grow-1">
                <input v-model="temp_title" class="form-control form-control-sm mb-2" placeholder="Title">
            </div>
            <button class="btn btn-sm btn-success ms-2" @click="save_header()" title="Save">
                <i class="fa-solid fa-check"></i>
            </button>
            <button class="btn btn-sm btn-secondary ms-1" @click="cancel_header()" title="Cancel">
                <i class="fa-solid fa-times"></i>
            </button>
        </template>
    </div>
    
    <template v-if="!editing_header">
        <hr v-if="note_template.description">
        <pre v-if="note_template.description">[[note_template.description]]</pre>
        <hr v-if="note_template.description">
    </template>
    <template v-else>
        <hr>
        <textarea v-model="temp_description" class="form-control form-control-sm" rows="3" placeholder="Description"></textarea>
        <hr>
    </template>
</div>

<hr class="fading-line mt-4 mb-4">

<template v-if="note_template">
    <div class="case-core-style">
        <div>
            version: [[note_template.version]]
        </div>
        <template v-if="!is_editing">
            <button class="btn btn-primary" @click="edit()">Edit</button>
            <div class="markdown-render-result" v-html="md.render(note_editor_render)"></div>
        </template>
        <template v-else>
            <button class="btn btn-primary" @click="save()">Save</button>

            <div style="display: flex;">
                <div class="note-editor" id="editor"></div>
                <div class="markdown-render" v-html="md.render(note_editor_render)"></div>
            </div>

        </template>
    </div>
</template>
<template v-else>
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</template>
{% endblock %}

{% block script %}
    <script type="module">
        const { createApp, ref, onMounted, nextTick } = Vue
        import {display_toast, message_list} from '/static/js/toaster.js'
        const { EditorView, basicSetup, languages } = window.CodeMirrorBundle;
        
        createApp({
            delimiters: ['[[', ']]'],
            setup() {
                const note_template = ref(null)

                let editor
                const note_editor_render = ref("")

                const md = window.markdownit()			// Library to Parse and display markdown
                md.use(mermaidMarkdown.default)			// Use mermaid library

                const is_editing = ref(false)
                const editing_header = ref(false)
                const temp_title = ref('')
                const temp_description = ref('')

                async function prepare_editor(default_content){
                    await nextTick()
                    const targetElement = document.getElementById('editor')
                    if(targetElement && targetElement.innerHTML === ""){
                            editor = new EditorView({
                                doc: default_content,
                                extensions: [basicSetup, languages.markdown(), EditorView.updateListener.of((v) => {
                                    if (v.docChanged) {
                                        note_editor_render.value = editor.state.doc.toString()
                                    }
                                })],
                                parent: targetElement
                            })
                    }
                    md.mermaid.init()
                }

                async function fetchNoteTemplate() {
                    note_template.value = null
                    const res = await fetch('/tools/note_template/{{note_template.id}}')
                    let loc = await res.json()
                    note_template.value = loc
                    note_editor_render.value = note_template.value.content
                    if(!note_editor_render.value){
                        is_editing.value = true
                        prepare_editor("\n\n")
                    }
                }

                async function save() {
                    if(note_editor_render.value){
                        is_editing.value = false
                        md.mermaid.init()

                        const res_msg = await fetch(
                            '/tools/note_template/{{note_template.id}}/edit_content',{
                                headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                                method: "POST",
                                body: JSON.stringify({"content": note_editor_render.value})
                            }
                        )
                        display_toast(res_msg)
                    }
                }

                async function edit() {
                    is_editing.value = true
                    prepare_editor(note_editor_render.value)
                }
                
                function edit_header() {
                    editing_header.value = true
                    temp_title.value = note_template.value.title
                    temp_description.value = note_template.value.description
                }
                
                function cancel_header() {
                    editing_header.value = false
                    temp_title.value = ''
                    temp_description.value = ''
                }
                
                async function save_header() {
                    if(!temp_title.value || !temp_description.value){
                        display_toast({status: 400, json: async () => ({message: 'Title and description are required', toast_class: 'warning-subtle'})})
                        return
                    }

                    const res_msg = await fetch(
                        '/tools/note_template/{{note_template.id}}/edit',{
                            headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                            method: "POST",
                            body: JSON.stringify({"title": temp_title.value, "description": temp_description.value})
                        }
                    )
                    if(await res_msg.status == 200){
                        note_template.value.title = temp_title.value
                        note_template.value.description = temp_description.value
                        editing_header.value = false
                        await fetchNoteTemplate()
                    }
                    display_toast(res_msg)
                }
                
                onMounted(() => {
                    fetchNoteTemplate()
                    md.mermaid.init()
                })

                return {
                    message_list, // Avoid warning
                    dayjs,

                    note_template,
                    md,
                    note_editor_render,
                    is_editing,
                    editing_header,
                    temp_title,
                    temp_description,

                    save,
                    edit,
                    edit_header,
                    cancel_header,
                    save_header
                }
            }
        }).mount('#main-container')

    </script>
{% endblock %}